<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="robots" content="noindex, nofollow">
<title>Admin | Hair Tattoo</title>
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üíà</text></svg>">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,400;9..40,500;9..40,700&family=Instrument+Serif:ital@0;1&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#FAFAF8;--card:#FFF;--text:#1A1A1A;--t2:#555;--t3:#888;--ac:#2D5A3D;--ac2:#3A7350;--al:#E8F0EB;--bd:#E8E6E3;--r:12px;--rs:8px;--f:'DM Sans',system-ui,sans-serif;--se:'Instrument Serif',Georgia,serif;--mw:1200px}
body{font-family:var(--f);background:var(--bg);color:var(--text);line-height:1.5;-webkit-font-smoothing:antialiased}
a{color:var(--ac);text-decoration:none}

/* GATE */
#gate{display:flex;align-items:center;justify-content:center;min-height:100vh;background:var(--bg)}
.gate-box{background:var(--card);border:1px solid var(--bd);border-radius:var(--r);padding:2rem;text-align:center;max-width:360px;width:100%}
.gate-box h2{font-size:1.125rem;margin-bottom:.25rem}
.gate-box p{font-size:.8125rem;color:var(--t2);margin-bottom:1rem}
.gate-box input{width:100%;padding:.625rem .75rem;border:1px solid var(--bd);border-radius:var(--rs);font-family:var(--f);font-size:.875rem;margin-bottom:.75rem}
.gate-box input:focus{outline:none;border-color:var(--ac)}
.gate-box button{width:100%;padding:.625rem;background:var(--ac);color:#fff;border:none;border-radius:var(--rs);font-family:var(--f);font-size:.875rem;font-weight:500;cursor:pointer}
.gate-box button:hover{background:var(--ac2)}
.gate-err{color:#DC2626;font-size:.8125rem;margin-bottom:.75rem;display:none}
#app{display:none}

/* NAV */
.nav{position:sticky;top:0;z-index:100;background:var(--text);padding:0 1.5rem;display:flex;align-items:center;justify-content:space-between;height:56px}
.nav-logo{font-family:var(--se);font-size:1.5rem;color:#fff;letter-spacing:-.02em}
.nav-logo span{opacity:.5}
.nav-link{font-size:.875rem;color:#aaa;font-weight:500;transition:color .15s}
.nav-link:hover{color:#fff}

/* LAYOUT ‚Äî shared horizontal rhythm */
.stats{display:grid;grid-template-columns:repeat(4,1fr);gap:1rem;max-width:var(--mw);margin:0 auto;padding:1.5rem 1.5rem .75rem}
.tabs-bar{display:flex;gap:0;border-bottom:1px solid var(--bd);background:var(--card);max-width:var(--mw);margin:0 auto;padding:0 1.5rem}
.container{max-width:var(--mw);margin:0 auto;padding:1rem 1.5rem 1.5rem}

/* STATS */
.stat{background:var(--card);border:1px solid var(--bd);border-radius:var(--r);padding:1.25rem;position:relative}
.stat-icon{position:absolute;top:1rem;right:1rem;width:36px;height:36px;border-radius:var(--rs);background:var(--al);display:flex;align-items:center;justify-content:center;font-size:1rem}
.stat-num{font-size:1.75rem;font-weight:700;line-height:1.2}
.stat-label{font-size:.8125rem;color:var(--t2);margin-top:.125rem}
.stat-sub{font-size:.6875rem;color:var(--t3);margin-top:.25rem}

/* TABS */
.tab{padding:.75rem 1.25rem;font-size:.875rem;font-weight:500;color:var(--t3);cursor:pointer;border-bottom:2px solid transparent;transition:all .15s;user-select:none}
.tab:hover{color:var(--t2)}
.tab.active{color:var(--ac);border-bottom-color:var(--ac)}
.tab .badge{display:inline-flex;align-items:center;justify-content:center;min-width:20px;height:20px;padding:0 6px;border-radius:10px;background:var(--al);color:var(--ac);font-size:.6875rem;font-weight:700;margin-left:.375rem}

.section{display:none}
.section.active{display:block}

/* TOOLBAR */
.toolbar{display:flex;gap:.75rem;align-items:center;margin-bottom:1rem;flex-wrap:wrap}
.search{flex:1;min-width:200px;padding:.5rem .75rem;border:1px solid var(--bd);border-radius:var(--rs);font-family:var(--f);font-size:.8125rem;background:var(--card)}
.search:focus{outline:none;border-color:var(--ac)}
.filters{display:flex;gap:.375rem;flex-wrap:wrap}
.chip{padding:.25rem .75rem;border-radius:20px;font-size:.75rem;font-weight:500;cursor:pointer;border:1px solid var(--bd);background:var(--card);color:var(--t2);transition:all .15s;user-select:none}
.chip:hover{border-color:var(--ac);color:var(--ac)}
.chip.active{background:var(--ac);color:#fff;border-color:var(--ac)}

/* TABLE */
.tbl{width:100%;border-collapse:collapse;font-size:.8125rem;table-layout:fixed}
.tbl th{text-align:left;padding:.5rem .75rem;font-size:.6875rem;font-weight:600;text-transform:uppercase;letter-spacing:.05em;color:var(--t3);border-bottom:1px solid var(--bd);background:var(--card);position:sticky;top:0}
.tbl td{padding:.625rem .75rem;border-bottom:1px solid var(--bd);vertical-align:middle;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.tbl tr{background:var(--card);transition:background .1s}
.tbl tr:hover{background:var(--bg)}
.tbl-wrap{background:var(--card);border:1px solid var(--bd);border-radius:var(--r);overflow:hidden}

/* Hidden row: muted text + subtle bg, but keep actions column legible */
.tbl tr.hidden-row{background:#F5F3F0}
.tbl tr.hidden-row:hover{background:#EFECE8}
.tbl tr.hidden-row>td{color:var(--t3)}
.tbl tr.hidden-row>td:last-child{color:var(--text)}

/* BADGES */
.badge-s{display:inline-block;padding:.125rem .5rem;border-radius:4px;font-size:.6875rem;font-weight:600;text-transform:uppercase;white-space:nowrap}
.b-active{background:#D1FAE5;color:#065F46}
.b-hidden{background:#FEF3C7;color:#92400E}
.b-archived{background:#FEE2E2;color:#991B1B}
.b-promoted{background:#EDE9FE;color:#6D28D9}
.b-pending{background:#FEF3C7;color:#92400E}
.b-approved{background:#D1FAE5;color:#065F46}
.b-rejected{background:#FEE2E2;color:#991B1B}
.b-read{background:var(--al);color:var(--ac)}
.b-unread{background:#DBEAFE;color:#1D4ED8}

/* ACTIONS ‚Äî three-dot button */
.act-btn{width:28px;height:28px;border-radius:var(--rs);border:1px solid var(--bd);background:var(--card);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:.875rem;color:var(--t2);transition:all .15s}
.act-btn:hover{background:var(--bg);border-color:var(--ac);color:var(--ac)}

/* ACTIONS ‚Äî floating menu (position:fixed, placed by JS) */
.act-menu{position:fixed;background:var(--card);border:1px solid var(--bd);border-radius:var(--rs);box-shadow:0 4px 12px rgba(0,0,0,.1);z-index:150;min-width:140px;padding:.25rem 0;display:none}
.act-menu.open{display:block}
.act-item{display:block;width:100%;padding:.5rem .75rem;font-size:.8125rem;color:var(--text);cursor:pointer;border:none;background:none;text-align:left;font-family:var(--f);transition:background .1s}
.act-item:hover{background:var(--bg)}
.act-item.danger{color:#DC2626}
.act-item.danger:hover{background:#FEF2F2}

/* PAGINATION */
.pag{display:flex;align-items:center;justify-content:space-between;padding:1rem 0;font-size:.8125rem;color:var(--t2)}
.pag-btns{display:flex;gap:.375rem}
.pag-btn{padding:.375rem .75rem;border:1px solid var(--bd);border-radius:var(--rs);background:var(--card);cursor:pointer;font-family:var(--f);font-size:.8125rem;color:var(--t2);transition:all .15s}
.pag-btn:hover:not(:disabled){border-color:var(--ac);color:var(--ac)}
.pag-btn:disabled{opacity:.4;cursor:not-allowed}

/* SLIDE-OUT PANEL */
.overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.3);z-index:100}
.overlay.open{display:block}
.panel{position:fixed;top:0;right:-480px;width:480px;max-width:100vw;height:100vh;background:var(--card);border-left:1px solid var(--bd);z-index:101;overflow-y:auto;transition:right .25s ease;box-shadow:-4px 0 20px rgba(0,0,0,.05)}
.panel.open{right:0}
.panel-head{padding:1.25rem 1.5rem;border-bottom:1px solid var(--bd);display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;background:var(--card);z-index:1}
.panel-head h2{font-size:1rem;font-weight:700}
.panel-close{width:32px;height:32px;border-radius:50%;border:none;background:var(--bg);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:1.125rem;color:var(--t2);transition:all .15s}
.panel-close:hover{background:var(--bd);color:var(--text)}
.panel-body{padding:1.5rem}
.pf{margin-bottom:1rem}
.pf label{display:block;font-size:.75rem;font-weight:600;color:var(--t2);margin-bottom:.25rem;text-transform:uppercase;letter-spacing:.03em}
.pf input,.pf textarea,.pf select{width:100%;padding:.5rem .75rem;border:1px solid var(--bd);border-radius:var(--rs);font-family:var(--f);font-size:.8125rem;background:var(--bg);color:var(--text)}
.pf input:focus,.pf textarea:focus,.pf select:focus{outline:none;border-color:var(--ac);background:var(--card)}
.pf textarea{resize:vertical;min-height:80px}
.pf-row{display:grid;grid-template-columns:1fr 1fr;gap:.75rem}
.pf-checks{display:flex;flex-wrap:wrap;gap:.375rem}
.pf-check{padding:.25rem .625rem;border:1px solid var(--bd);border-radius:4px;font-size:.75rem;cursor:pointer;transition:all .15s;background:var(--card);user-select:none}
.pf-check.on{background:var(--al);border-color:var(--ac);color:var(--ac);font-weight:500}
.panel-save{width:100%;padding:.625rem;background:var(--ac);color:#fff;border:none;border-radius:var(--rs);font-family:var(--f);font-size:.875rem;font-weight:500;cursor:pointer;margin-top:.5rem}
.panel-save:hover{background:var(--ac2)}
.panel-save:disabled{opacity:.5;cursor:not-allowed}
.panel-msg{text-align:center;padding:.5rem;font-size:.8125rem;margin-top:.5rem}
/* Panel read-only rows */
.pf-static{font-size:.8125rem;color:var(--text);padding:.375rem 0}

/* Panel tabs */
.ptabs{display:flex;gap:0;padding:0 1.5rem;border-bottom:1px solid var(--bd);background:var(--card);position:sticky;top:52px;z-index:1}
.ptab{padding:.625rem 1rem;font-size:.8125rem;font-weight:500;color:var(--t3);cursor:pointer;border-bottom:2px solid transparent;transition:all .15s;user-select:none}
.ptab:hover{color:var(--t2)}
.ptab.active{color:var(--ac);border-bottom-color:var(--ac)}
.ptab-content{display:none}
.ptab-content.active{display:block}

/* Photos tab */
.photo-placeholder{text-align:center;padding:2rem 1rem;color:var(--t3)}
.photo-placeholder svg{display:block;margin:0 auto .75rem;color:var(--bd)}
.photo-placeholder p{font-size:.8125rem;margin-bottom:.25rem}
.photo-placeholder .hint{font-size:.75rem;color:var(--t3);margin-top:.5rem}
.photo-avatar-area{display:flex;flex-direction:column;align-items:center;margin-bottom:1.5rem;padding-bottom:1.5rem;border-bottom:1px solid var(--bd)}
.photo-avatar{width:80px;height:80px;border-radius:50%;border:2px dashed var(--bd);display:flex;align-items:center;justify-content:center;background:var(--bg);color:var(--t3);font-size:.75rem;margin-bottom:.5rem}
.photo-grid-p{display:grid;grid-template-columns:repeat(3,1fr);gap:.75rem;margin-bottom:1.5rem}
.photo-slot{aspect-ratio:1;border:2px dashed var(--bd);border-radius:var(--rs);display:flex;flex-direction:column;align-items:center;justify-content:center;background:var(--bg);color:var(--t3);font-size:.6875rem;gap:.25rem}
.photo-note{font-size:.75rem;color:var(--t3);text-align:center;padding:.75rem;border-top:1px solid var(--bd);margin-top:.5rem}

/* LEADS TABLE */
.lead-expand{display:none;padding:.75rem;background:var(--bg);border-radius:var(--rs);margin-top:.5rem;font-size:.8125rem;color:var(--text);line-height:1.6}
.lead-row{cursor:pointer}
.lead-row:hover{background:#F5F5F3}
.mark-read{padding:.25rem .5rem;border:1px solid var(--bd);border-radius:4px;background:var(--card);font-size:.6875rem;font-family:var(--f);cursor:pointer;color:var(--t2);transition:all .15s}
.mark-read:hover{border-color:var(--ac);color:var(--ac)}

/* SIGNUP INLINE ACTIONS */
.su-btn{padding:.25rem .5rem;border-radius:4px;font-size:.6875rem;font-family:var(--f);font-weight:500;cursor:pointer;border:1px solid;transition:all .15s;background:var(--card)}
.su-approve{border-color:var(--ac);color:var(--ac)}
.su-approve:hover{background:var(--al)}
.su-reject{border-color:#DC2626;color:#DC2626}
.su-reject:hover{background:#FEF2F2}
.su-view{border-color:var(--bd);color:var(--t2)}
.su-view:hover{border-color:var(--ac);color:var(--ac)}

/* CONFIRM DIALOG */
.confirm-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:200;align-items:center;justify-content:center}
.confirm-overlay.open{display:flex}
.confirm-box{background:var(--card);border-radius:var(--r);padding:1.5rem;max-width:380px;width:100%;text-align:center}
.confirm-box h3{font-size:1rem;margin-bottom:.5rem}
.confirm-box p{font-size:.8125rem;color:var(--t2);margin-bottom:1.25rem}
.confirm-btns{display:flex;gap:.5rem;justify-content:center}
.confirm-btns button{padding:.5rem 1.25rem;border-radius:var(--rs);font-family:var(--f);font-size:.8125rem;font-weight:500;cursor:pointer;border:1px solid var(--bd)}
.cbtn-cancel{background:var(--card);color:var(--t2)}
.cbtn-cancel:hover{background:var(--bg)}
.cbtn-danger{background:#DC2626;color:#fff;border-color:#DC2626}
.cbtn-danger:hover{background:#B91C1C}

.empty{text-align:center;padding:3rem 1rem;color:var(--t3);font-size:.9375rem}

@media(max-width:768px){
  .stats{grid-template-columns:repeat(2,1fr)}
  .panel{width:100vw}
  .toolbar{flex-direction:column;align-items:stretch}
  .search{min-width:auto}
}
@media(max-width:480px){
  .stats{grid-template-columns:1fr 1fr}
  .tbl{font-size:.75rem}
  .tbl th,.tbl td{padding:.5rem}
}
</style>
</head>
<body>

<div id="gate">
  <div class="gate-box">
    <h2>Admin Access</h2>
    <p>Enter the admin password to continue</p>
    <div class="gate-err" id="gateErr">Incorrect password</div>
    <input type="password" id="gatePw" placeholder="Password" onkeydown="if(event.key==='Enter')checkGate()">
    <button onclick="checkGate()">Sign In</button>
  </div>
</div>

<div id="app">
  <nav class="nav">
    <div class="nav-logo">Hair Tattoo <span>Admin</span></div>
    <a href="/" target="_blank" class="nav-link">View Site &rarr;</a>
  </nav>

  <div class="stats">
    <div class="stat"><div class="stat-icon">üìã</div><div class="stat-num" id="sTotal">-</div><div class="stat-label">Total Listings</div></div>
    <div class="stat"><div class="stat-icon">üëÅ</div><div class="stat-num" id="sViews">-</div><div class="stat-label">Page Views</div></div>
    <div class="stat"><div class="stat-icon">üí¨</div><div class="stat-num" id="sLeads">-</div><div class="stat-label">Total Leads</div></div>
    <div class="stat"><div class="stat-icon">üí∞</div><div class="stat-num" id="sRev">$0</div><div class="stat-label">Revenue</div><div class="stat-sub">Coming soon</div></div>
  </div>

  <div class="tabs-bar">
    <div class="tab active" data-tab="listings" onclick="showTab('listings')">Listings <span class="badge" id="cntListings">0</span></div>
    <div class="tab" data-tab="leads" onclick="showTab('leads')">Leads <span class="badge" id="cntLeads">0</span></div>
    <div class="tab" data-tab="signups" onclick="showTab('signups')">Signups <span class="badge" id="cntSignups">0</span></div>
    <div class="tab" data-tab="reviews" onclick="showTab('reviews')">Reviews <span class="badge" id="cntReviews">0</span></div>
  </div>

  <div class="container">
    <!-- LISTINGS -->
    <div class="section active" id="sec-listings">
      <div class="toolbar">
        <input class="search" id="listSearch" placeholder="Search by name or city..." oninput="renderListings()">
        <div class="filters" id="listFilters">
          <span class="chip active" data-filter="all" onclick="setFilter(this)">All</span>
          <span class="chip" data-filter="active" onclick="setFilter(this)">Active</span>
          <span class="chip" data-filter="hidden" onclick="setFilter(this)">Hidden</span>
          <span class="chip" data-filter="promoted" onclick="setFilter(this)">Promoted</span>
          <span class="chip" data-filter="claimed" onclick="setFilter(this)">Claimed</span>
        </div>
      </div>
      <div class="tbl-wrap">
        <table class="tbl" id="listTbl">
          <colgroup><col style="width:25%"><col style="width:18%"><col style="width:12%"><col style="width:12%"><col style="width:10%"><col style="width:10%"><col style="width:48px"></colgroup>
          <thead><tr><th>Name</th><th>City / State</th><th>Status</th><th>Promo</th><th>Views</th><th>Leads</th><th></th></tr></thead>
          <tbody id="listBody"></tbody>
        </table>
      </div>
      <div class="pag" id="listPag"></div>
    </div>

    <!-- LEADS -->
    <div class="section" id="sec-leads">
      <div class="tbl-wrap">
        <table class="tbl">
          <colgroup><col style="width:10%"><col style="width:18%"><col style="width:15%"><col style="width:25%"><col style="width:15%"><col style="width:8%"><col style="width:60px"></colgroup>
          <thead><tr><th>Date</th><th>Name</th><th>Phone</th><th>Message</th><th>Listing</th><th>Status</th><th></th></tr></thead>
          <tbody id="leadBody"></tbody>
        </table>
      </div>
      <div id="leadEmpty"></div>
    </div>

    <!-- SIGNUPS -->
    <div class="section" id="sec-signups">
      <div class="tbl-wrap">
        <table class="tbl">
          <colgroup><col style="width:9%"><col style="width:18%"><col style="width:18%"><col style="width:12%"><col style="width:14%"><col style="width:10%"><col style="width:8%"><col style="width:100px"></colgroup>
          <thead><tr><th>Date</th><th>Business</th><th>Email</th><th>Phone</th><th>City</th><th>Instagram</th><th>Status</th><th>Actions</th></tr></thead>
          <tbody id="signupBody"></tbody>
        </table>
      </div>
      <div id="signupEmpty"></div>
    </div>

    <!-- REVIEWS -->
    <div class="section" id="sec-reviews">
      <div class="toolbar">
        <div class="filters" id="reviewFilters">
          <span class="chip active" data-filter="pending" onclick="setReviewFilter(this)">Pending</span>
          <span class="chip" data-filter="approved" onclick="setReviewFilter(this)">Approved</span>
          <span class="chip" data-filter="rejected" onclick="setReviewFilter(this)">Rejected</span>
        </div>
      </div>
      <div class="tbl-wrap">
        <table class="tbl">
          <colgroup><col style="width:10%"><col style="width:15%"><col style="width:10%"><col style="width:20%"><col style="width:15%"><col style="width:10%"><col style="width:120px"></colgroup>
          <thead><tr><th>Date</th><th>Reviewer</th><th>Rating</th><th>Review</th><th>Listing</th><th>Status</th><th>Actions</th></tr></thead>
          <tbody id="reviewBody"></tbody>
        </table>
      </div>
      <div id="reviewEmpty"></div>
    </div>
  </div>
</div>

<!-- FLOATING ACTION MENU (positioned by JS, outside table overflow) -->
<div class="act-menu" id="actMenu"></div>

<!-- EDIT PANEL -->
<div class="overlay" id="overlay" onclick="closePanel()"></div>
<div class="panel" id="panel">
  <div class="panel-head"><h2 id="panelTitle">Edit Listing</h2><button class="panel-close" onclick="closePanel()">&times;</button></div>
  <div class="ptabs" id="panelTabs">
    <div class="ptab active" onclick="showPanelTab('details')">Details</div>
    <div class="ptab" onclick="showPanelTab('photos')">Photos</div>
  </div>
  <div class="panel-body" id="panelBody">
    <input type="hidden" id="editId">

    <!-- DETAILS TAB -->
    <div class="ptab-content active" id="ptab-details">
      <div class="pf"><label>Name</label><input id="eName"></div>
      <div class="pf"><label>Address</label><input id="eAddress"></div>
      <div class="pf-row">
        <div class="pf"><label>City</label><input id="eCity"></div>
        <div class="pf"><label>State</label><input id="eState" maxlength="2" style="text-transform:uppercase"></div>
      </div>
      <div class="pf-row">
        <div class="pf"><label>Zip</label><input id="eZip"></div>
        <div class="pf"><label>Phone</label><input id="ePhone"></div>
      </div>
      <div class="pf"><label>Email</label><input id="eEmail" type="email"></div>
      <div class="pf"><label>Website</label><input id="eWebsite"></div>
      <div class="pf">
        <label>Services</label>
        <div class="pf-checks" id="eSvcChecks"></div>
      </div>
      <div class="pf"><label>Price Range</label>
        <select id="ePriceRange"><option value="$">$</option><option value="$$">$$</option><option value="$$$">$$$</option></select>
      </div>
      <div class="pf"><label>About</label><textarea id="eAbout"></textarea></div>
      <div class="pf-row">
        <div class="pf"><label>Instagram</label><input id="eInstagram"></div>
        <div class="pf"><label>Facebook</label><input id="eFacebook"></div>
      </div>
      <div class="pf"><label>TikTok</label><input id="eTiktok"></div>
      <div class="pf"><label>Status</label>
        <select id="eStatus"><option value="active">Active</option><option value="hidden">Hidden</option><option value="archived">Archived</option></select>
      </div>
      <button class="panel-save" id="saveBtn" onclick="saveListing()">Save Changes</button>
      <div class="panel-msg" id="panelMsg"></div>
    </div>

    <!-- PHOTOS TAB -->
    <div class="ptab-content" id="ptab-photos">
      <div class="photo-avatar-area">
        <div class="photo-avatar">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="8" r="4"/><path d="M20 21a8 8 0 1 0-16 0"/></svg>
        </div>
        <div style="font-size:.75rem;font-weight:600;color:var(--t2);text-transform:uppercase;letter-spacing:.03em">Profile Photo</div>
        <div style="font-size:.75rem;color:var(--t3);margin-top:.25rem">No photo uploaded</div>
      </div>
      <div style="font-size:.75rem;font-weight:600;color:var(--t2);text-transform:uppercase;letter-spacing:.03em;margin-bottom:.75rem">Gallery (up to 6)</div>
      <div class="photo-grid-p">
        <div class="photo-slot"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="m21 15-5-5L5 21"/></svg><span>Empty</span></div>
        <div class="photo-slot"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="m21 15-5-5L5 21"/></svg><span>Empty</span></div>
        <div class="photo-slot"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="m21 15-5-5L5 21"/></svg><span>Empty</span></div>
        <div class="photo-slot"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="m21 15-5-5L5 21"/></svg><span>Empty</span></div>
        <div class="photo-slot"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="m21 15-5-5L5 21"/></svg><span>Empty</span></div>
        <div class="photo-slot"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="m21 15-5-5L5 21"/></svg><span>Empty</span></div>
      </div>
      <div class="photo-placeholder">
        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
        <p>Photo management will be available once image uploads are configured</p>
      </div>
      <div class="photo-note">AI content moderation coming soon</div>
    </div>

  </div>
</div>

<!-- CONFIRM DIALOG -->
<div class="confirm-overlay" id="confirmOverlay">
  <div class="confirm-box">
    <h3 id="confirmTitle">Delete listing?</h3>
    <p id="confirmText">This will archive the listing. It can be restored later.</p>
    <div class="confirm-btns">
      <button class="cbtn-cancel" onclick="closeConfirm()">Cancel</button>
      <button class="cbtn-danger" id="confirmAction">Delete</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script>
const SB=window.supabase.createClient('https://ingorrzmoudvoknhwjjb.supabase.co','eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImluZ29ycnptb3Vkdm9rbmh3ampiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA2NDY1NTIsImV4cCI6MjA4NjIyMjU1Mn0.rpcraVuvgRWX1NJtZyUQAzDp4rZhw4cpRm4dRx9yxJc');

const ADMIN_HASH='bce546bf728da1796394c4d59f18e9b61b534992627772a033261e4f94e71ab8';
const PAGE_SIZE=50;
const ALL_SERVICES=['Hairline Restoration','Density Fill','Scar Camouflage','Female SMP','Beard SMP','Alopecia Treatment'];

let allListings=[];
let allLeads=[];
let allSignups=[];
let allReviews=[];
let listPage=0;
let listFilter='all';
let reviewFilter='pending';
let openMenuId=null;

// ‚îÄ‚îÄ PASSWORD GATE ‚îÄ‚îÄ
async function sha256(str){
  const buf=await crypto.subtle.digest('SHA-256',new TextEncoder().encode(str));
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
}
async function checkGate(){
  const pw=document.getElementById('gatePw').value;
  if(await sha256(pw)===ADMIN_HASH){
    localStorage.setItem('ht_admin','1');
    document.getElementById('gate').style.display='none';
    document.getElementById('app').style.display='block';
    loadAll();
  } else {
    document.getElementById('gateErr').style.display='block';
  }
}
if(localStorage.getItem('ht_admin')==='1'){
  document.getElementById('gate').style.display='none';
  document.getElementById('app').style.display='block';
  loadAll();
}

// ‚îÄ‚îÄ TABS ‚îÄ‚îÄ
function showTab(name){
  document.querySelectorAll('.tab').forEach(t=>t.classList.toggle('active',t.dataset.tab===name));
  document.querySelectorAll('.section').forEach(s=>s.classList.toggle('active',s.id==='sec-'+name));
}

// ‚îÄ‚îÄ LOAD ALL DATA ‚îÄ‚îÄ
async function loadAll(){
  const[listings,leads,signups,viewData,reviewsData]=await Promise.all([
    SB.from('listings').select('*').neq('status','archived').order('name'),
    SB.from('leads').select('*,listings(name,slug)').order('created_at',{ascending:false}),
    SB.from('signups').select('*').order('created_at',{ascending:false}),
    SB.from('page_views').select('listing_id'),
    SB.from('reviews').select('*,listings(name,slug)').order('created_at',{ascending:false})
  ]);

  allListings=listings.data||[];
  allLeads=leads.data||[];
  allSignups=signups.data||[];
  allReviews=reviewsData.data||[];

  // Count views per listing
  const viewMap={};
  (viewData.data||[]).forEach(v=>{viewMap[v.listing_id]=(viewMap[v.listing_id]||0)+1;});
  allListings.forEach(l=>{l._views=viewMap[l.id]||0;});

  // Count leads per listing
  const leadMap={};
  allLeads.forEach(l=>{if(l.listing_id)leadMap[l.listing_id]=(leadMap[l.listing_id]||0)+1;});
  allListings.forEach(l=>{l._leads=leadMap[l.id]||0;});

  // Stats
  document.getElementById('sTotal').textContent=allListings.length;
  document.getElementById('sViews').textContent=(viewData.data||[]).length.toLocaleString();
  document.getElementById('sLeads').textContent=allLeads.length;
  document.getElementById('cntListings').textContent=allListings.length;
  document.getElementById('cntLeads').textContent=allLeads.length;
  document.getElementById('cntSignups').textContent=allSignups.length;
  document.getElementById('cntReviews').textContent=allReviews.filter(r=>r.status==='pending').length;

  renderListings();
  renderLeads();
  renderSignups();
  renderReviews();
}

// ‚îÄ‚îÄ LISTINGS ‚îÄ‚îÄ
function getFiltered(){
  let list=allListings;
  const q=document.getElementById('listSearch').value.toLowerCase().trim();
  if(q) list=list.filter(l=>(l.name||'').toLowerCase().includes(q)||(l.city||'').toLowerCase().includes(q));
  if(listFilter==='active') list=list.filter(l=>l.status==='active'||!l.status);
  else if(listFilter==='hidden') list=list.filter(l=>l.status==='hidden');
  else if(listFilter==='promoted') list=list.filter(l=>l.promoted);
  else if(listFilter==='claimed') list=list.filter(l=>l.claimed);
  return list;
}

function setFilter(el){
  document.querySelectorAll('#listFilters .chip').forEach(c=>c.classList.remove('active'));
  el.classList.add('active');
  listFilter=el.dataset.filter;
  listPage=0;
  renderListings();
}

function renderListings(){
  const filtered=getFiltered();
  const total=filtered.length;
  const pages=Math.ceil(total/PAGE_SIZE);
  if(listPage>=pages) listPage=Math.max(0,pages-1);
  const start=listPage*PAGE_SIZE;
  const slice=filtered.slice(start,start+PAGE_SIZE);

  const body=document.getElementById('listBody');
  if(!slice.length){
    body.innerHTML='<tr><td colspan="7" style="text-align:center;padding:2rem;color:var(--t3)">No listings found</td></tr>';
  } else {
    body.innerHTML=slice.map(l=>{
      const st=l.status||'active';
      const cls=st==='hidden'?' hidden-row':'';
      return `<tr class="${cls}" data-id="${l.id}">
        <td style="font-weight:600" title="${esc(l.name)}">${esc(l.name)}</td>
        <td>${esc(l.city)}, ${esc(l.state)}</td>
        <td><span class="badge-s b-${st}">${st}</span></td>
        <td>${l.promoted?'<span class="badge-s b-promoted">Promoted</span>':'-'}</td>
        <td>${l._views||0}</td>
        <td>${l._leads||0}</td>
        <td><button class="act-btn" data-menu-id="${l.id}" onclick="event.stopPropagation();toggleMenu(${l.id},this)">&#8943;</button></td>
      </tr>`;
    }).join('');
  }

  const pagEl=document.getElementById('listPag');
  if(pages<=1){pagEl.innerHTML='';return;}
  pagEl.innerHTML=`
    <div style="font-size:.8125rem;color:var(--t3)">Showing ${start+1}-${Math.min(start+PAGE_SIZE,total)} of ${total}</div>
    <div class="pag-btns">
      <button class="pag-btn" onclick="listPage--;renderListings()" ${listPage===0?'disabled':''}>Prev</button>
      <button class="pag-btn" onclick="listPage++;renderListings()" ${listPage>=pages-1?'disabled':''}>Next</button>
    </div>`;
}

// ‚îÄ‚îÄ FLOATING ACTION MENU ‚îÄ‚îÄ
function toggleMenu(id,btnEl){
  const menu=document.getElementById('actMenu');
  if(openMenuId===id){closeMenus();return;}
  closeMenus();

  const l=allListings.find(x=>x.id===id);if(!l)return;
  const st=l.status||'active';

  menu.innerHTML=`
    <button class="act-item" onclick="openEdit(${id})">Edit</button>
    <button class="act-item" onclick="toggleHide(${id})">${st==='hidden'?'Unhide':'Hide'}</button>
    <button class="act-item" onclick="togglePromote(${id})">${l.promoted?'Unpromote':'Promote'}</button>
    <button class="act-item danger" onclick="confirmDelete(${id})">Delete</button>`;

  // Position menu relative to button
  const rect=btnEl.getBoundingClientRect();
  menu.style.top=(rect.bottom+4)+'px';
  menu.style.left='auto';
  menu.style.right=(window.innerWidth-rect.right)+'px';

  menu.classList.add('open');
  openMenuId=id;
}
function closeMenus(){
  const menu=document.getElementById('actMenu');
  menu.classList.remove('open');
  openMenuId=null;
}
document.addEventListener('click',e=>{
  if(!e.target.closest('.act-btn')&&!e.target.closest('.act-menu')) closeMenus();
});

// ‚îÄ‚îÄ HIDE / PROMOTE ‚îÄ‚îÄ
async function toggleHide(id){
  closeMenus();
  const l=allListings.find(x=>x.id===id);if(!l)return;
  const newStatus=(l.status==='hidden')?'active':'hidden';
  await SB.from('listings').update({status:newStatus}).eq('id',id);
  l.status=newStatus;
  renderListings();
}
async function togglePromote(id){
  closeMenus();
  const l=allListings.find(x=>x.id===id);if(!l)return;
  const newPromoted=!l.promoted;
  const until=newPromoted?new Date(Date.now()+30*24*60*60*1000).toISOString():null;
  await SB.from('listings').update({promoted:newPromoted,promoted_until:until}).eq('id',id);
  l.promoted=newPromoted;
  l.promoted_until=until;
  renderListings();
}

// ‚îÄ‚îÄ DELETE (ARCHIVE) ‚îÄ‚îÄ
let deleteId=null;
function confirmDelete(id){
  closeMenus();
  const l=allListings.find(x=>x.id===id);if(!l)return;
  deleteId=id;
  document.getElementById('confirmTitle').textContent='Delete "'+l.name+'"?';
  document.getElementById('confirmOverlay').classList.add('open');
  document.getElementById('confirmAction').onclick=async function(){
    await SB.from('listings').update({status:'archived'}).eq('id',id);
    allListings=allListings.filter(x=>x.id!==id);
    document.getElementById('sTotal').textContent=allListings.length;
    document.getElementById('cntListings').textContent=allListings.length;
    renderListings();
    closeConfirm();
  };
}
function closeConfirm(){
  document.getElementById('confirmOverlay').classList.remove('open');
  deleteId=null;
}

// ‚îÄ‚îÄ EDIT PANEL ‚îÄ‚îÄ
function openEdit(id){
  closeMenus();
  const l=allListings.find(x=>x.id===id);if(!l)return;
  document.getElementById('editId').value=id;
  document.getElementById('panelTitle').textContent='Edit: '+l.name;
  document.getElementById('eName').value=l.name||'';
  document.getElementById('eAddress').value=l.address||'';
  document.getElementById('eCity').value=l.city||'';
  document.getElementById('eState').value=l.state||'';
  document.getElementById('eZip').value=l.zip||'';
  document.getElementById('ePhone').value=l.phone||'';
  document.getElementById('eEmail').value=l.email||'';
  document.getElementById('eWebsite').value=l.website||'';
  document.getElementById('eAbout').value=l.about||'';
  document.getElementById('eInstagram').value=l.instagram||'';
  document.getElementById('eFacebook').value=l.facebook||'';
  document.getElementById('eTiktok').value=l.tiktok||'';
  document.getElementById('ePriceRange').value=l.price_range||'$$';
  document.getElementById('eStatus').value=l.status||'active';

  const svcs=l.services||[];
  document.getElementById('eSvcChecks').innerHTML=ALL_SERVICES.map(s=>{
    const on=svcs.includes(s)?'on':'';
    return `<span class="pf-check ${on}" onclick="this.classList.toggle('on')">${esc(s)}</span>`;
  }).join('');

  document.getElementById('panelMsg').textContent='';
  document.getElementById('saveBtn').style.display='';
  showPanelTab('details');
  document.getElementById('panelTabs').style.display='';
  document.getElementById('overlay').classList.add('open');
  document.getElementById('panel').classList.add('open');
}

function showPanelTab(name){
  document.querySelectorAll('.ptab').forEach(t=>t.classList.toggle('active',t.textContent.toLowerCase()===name));
  document.querySelectorAll('.ptab-content').forEach(c=>c.classList.toggle('active',c.id==='ptab-'+name));
}
function closePanel(){
  document.getElementById('overlay').classList.remove('open');
  document.getElementById('panel').classList.remove('open');
}

async function saveListing(){
  const id=parseInt(document.getElementById('editId').value);
  const btn=document.getElementById('saveBtn');
  btn.disabled=true;btn.textContent='Saving...';

  const svcs=[];
  document.querySelectorAll('#eSvcChecks .pf-check.on').forEach(el=>svcs.push(el.textContent));

  const row={
    name:document.getElementById('eName').value.trim(),
    address:document.getElementById('eAddress').value.trim()||null,
    city:document.getElementById('eCity').value.trim(),
    state:document.getElementById('eState').value.trim().toUpperCase(),
    zip:document.getElementById('eZip').value.trim()||null,
    phone:document.getElementById('ePhone').value.trim()||null,
    email:document.getElementById('eEmail').value.trim()||null,
    website:document.getElementById('eWebsite').value.trim()||null,
    about:document.getElementById('eAbout').value.trim()||null,
    instagram:document.getElementById('eInstagram').value.trim()||null,
    facebook:document.getElementById('eFacebook').value.trim()||null,
    tiktok:document.getElementById('eTiktok').value.trim()||null,
    price_range:document.getElementById('ePriceRange').value,
    status:document.getElementById('eStatus').value,
    services:svcs
  };

  const{error}=await SB.from('listings').update(row).eq('id',id);
  btn.disabled=false;btn.textContent='Save Changes';
  if(error){
    document.getElementById('panelMsg').innerHTML='<span style="color:#DC2626">Error: '+esc(error.message)+'</span>';
    return;
  }
  document.getElementById('panelMsg').innerHTML='<span style="color:var(--ac)">Saved successfully</span>';
  const l=allListings.find(x=>x.id===id);
  if(l) Object.assign(l,row);
  renderListings();
}

// ‚îÄ‚îÄ LEADS ‚îÄ‚îÄ
function renderLeads(){
  const body=document.getElementById('leadBody');
  if(!allLeads.length){
    body.innerHTML='';
    document.getElementById('leadEmpty').innerHTML='<div class="empty">No leads yet</div>';
    return;
  }
  document.getElementById('leadEmpty').innerHTML='';
  body.innerHTML=allLeads.map((l,i)=>{
    const dt=new Date(l.created_at);
    const dateStr=dt.toLocaleDateString('en-US',{month:'short',day:'numeric'});
    const listing=l.listings?esc(l.listings.name):'‚Äî';
    const isRead=l.read;
    const msgPreview=l.sender_message?(esc(l.sender_message).substring(0,40)+(l.sender_message.length>40?'...':'')):'-';
    return `<tr class="lead-row" onclick="toggleLead(${i})">
      <td>${dateStr}</td>
      <td style="font-weight:600">${esc(l.sender_name)}</td>
      <td>${esc(l.sender_phone)}</td>
      <td title="${l.sender_message?esc(l.sender_message):''}">${msgPreview}</td>
      <td style="color:var(--ac)">${listing}</td>
      <td><span class="badge-s ${isRead?'b-read':'b-unread'}">${isRead?'Read':'New'}</span></td>
      <td>${!isRead?`<button class="mark-read" onclick="event.stopPropagation();markRead(${l.id},${i})">Mark read</button>`:''}</td>
    </tr>
    <tr id="lead-detail-${i}" style="display:none"><td colspan="7">
      <div class="lead-expand" style="display:block">
        <strong>Full message:</strong><br>${l.sender_message?esc(l.sender_message):'<em style="color:var(--t3)">No message</em>'}
        <br><br><strong>Phone:</strong> ${esc(l.sender_phone)}
        ${l.listings?'<br><strong>Listing:</strong> '+esc(l.listings.name)+' ('+esc(l.listings.slug)+')':''}
        <br><strong>Date:</strong> ${dt.toLocaleString()}
      </div>
    </td></tr>`;
  }).join('');
}

function toggleLead(i){
  const row=document.getElementById('lead-detail-'+i);
  if(row) row.style.display=row.style.display==='none'?'table-row':'none';
}

async function markRead(id,i){
  await SB.from('leads').update({read:true}).eq('id',id);
  if(allLeads[i]) allLeads[i].read=true;
  renderLeads();
}

// ‚îÄ‚îÄ SIGNUPS ‚îÄ‚îÄ
function renderSignups(){
  const body=document.getElementById('signupBody');
  if(!allSignups.length){
    body.innerHTML='';
    document.getElementById('signupEmpty').innerHTML='<div class="empty">No signups yet</div>';
    return;
  }
  document.getElementById('signupEmpty').innerHTML='';
  body.innerHTML=allSignups.map((s,i)=>{
    const dt=new Date(s.created_at);
    const dateStr=dt.toLocaleDateString('en-US',{month:'short',day:'numeric'});
    const st=s.status||'pending';
    const isPending=st==='pending';
    return `<tr>
      <td>${dateStr}</td>
      <td style="font-weight:600" title="${esc(s.business_name)}">${esc(s.business_name)}</td>
      <td title="${esc(s.email)}">${esc(s.email)}</td>
      <td>${esc(s.phone||'-')}</td>
      <td>${esc(s.city_state||'-')}</td>
      <td>${s.instagram?esc(s.instagram):'-'}</td>
      <td><span class="badge-s b-${st}">${st}</span></td>
      <td style="white-space:nowrap">${isPending
        ?`<button class="su-btn su-approve" onclick="approveSignup(${i})">Approve</button> <button class="su-btn su-reject" onclick="rejectSignup(${i})">Reject</button>`
        :`<button class="su-btn su-view" onclick="viewSignup(${i})">View</button>`
      }</td>
    </tr>`;
  }).join('');
}

async function approveSignup(idx){
  const s=allSignups[idx];if(!s)return;
  const parts=(s.city_state||'').split(',').map(p=>p.trim());
  const slug=(s.business_name||'').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-|-$/g,'');

  const listing={
    name:s.business_name,
    slug:slug,
    city:parts[0]||'',
    state:parts[1]||'',
    email:s.email||null,
    phone:s.phone||null,
    instagram:s.instagram?s.instagram.replace(/^@/,''):null,
    status:'active',
    services:[],
    price_range:'$$',
    claimed:false
  };

  const{error:insertErr}=await SB.from('listings').upsert(listing,{onConflict:'slug'}).select();
  if(insertErr){alert('Error creating listing: '+insertErr.message);return;}

  const{error:updateErr}=await SB.from('signups').update({status:'approved'}).eq('id',s.id);
  if(updateErr){alert('Listing created but failed to update signup status: '+updateErr.message);return;}

  s.status='approved';
  renderSignups();
  loadAll();
}

async function rejectSignup(idx){
  const s=allSignups[idx];if(!s)return;
  const{error}=await SB.from('signups').update({status:'rejected'}).eq('id',s.id);
  if(error){alert('Error: '+error.message);return;}
  s.status='rejected';
  renderSignups();
}

function viewSignup(idx){
  const s=allSignups[idx];if(!s)return;
  document.getElementById('panelTitle').textContent='Signup: '+s.business_name;
  document.getElementById('panelTabs').style.display='none';
  document.getElementById('panelBody').innerHTML=`
    <div class="pf"><label>Business Name</label><div class="pf-static">${esc(s.business_name)}</div></div>
    <div class="pf"><label>Email</label><div class="pf-static">${esc(s.email)}</div></div>
    <div class="pf"><label>Phone</label><div class="pf-static">${esc(s.phone||'-')}</div></div>
    <div class="pf"><label>City / State</label><div class="pf-static">${esc(s.city_state||'-')}</div></div>
    <div class="pf"><label>Instagram</label><div class="pf-static">${s.instagram?esc(s.instagram):'-'}</div></div>
    <div class="pf"><label>Status</label><div class="pf-static"><span class="badge-s b-${s.status}">${s.status}</span></div></div>
    <div class="pf"><label>Submitted</label><div class="pf-static">${new Date(s.created_at).toLocaleString()}</div></div>
  `;
  document.getElementById('overlay').classList.add('open');
  document.getElementById('panel').classList.add('open');
}

// Restore edit panel HTML when closing after a signup view
const editPanelHTML=document.getElementById('panelBody').innerHTML;
function closePanel(){
  document.getElementById('overlay').classList.remove('open');
  document.getElementById('panel').classList.remove('open');
  // Restore edit form if it was replaced by signup view
  setTimeout(()=>{document.getElementById('panelBody').innerHTML=editPanelHTML;},300);
}

// ‚îÄ‚îÄ REVIEWS ‚îÄ‚îÄ
function setReviewFilter(el){
  document.querySelectorAll('#reviewFilters .chip').forEach(c=>c.classList.remove('active'));
  el.classList.add('active');
  reviewFilter=el.dataset.filter;
  renderReviews();
}

function starsText(n){return '\u2605'.repeat(n)+'\u2606'.repeat(5-n);}

function renderReviews(){
  const body=document.getElementById('reviewBody');
  const filtered=allReviews.filter(r=>r.status===reviewFilter);
  if(!filtered.length){
    body.innerHTML='';
    document.getElementById('reviewEmpty').innerHTML='<div class="empty">No '+reviewFilter+' reviews</div>';
    return;
  }
  document.getElementById('reviewEmpty').innerHTML='';
  body.innerHTML=filtered.map((r,i)=>{
    const dt=new Date(r.created_at);
    const dateStr=dt.toLocaleDateString('en-US',{month:'short',day:'numeric'});
    const listing=r.listings?esc(r.listings.name):'‚Äî';
    const preview=r.body?(esc(r.body).substring(0,60)+(r.body.length>60?'...':'')):'-';
    const st=r.status;
    return `<tr>
      <td>${dateStr}</td>
      <td style="font-weight:600">${esc(r.reviewer_name)}</td>
      <td style="color:#F59E0B">${starsText(r.rating)}</td>
      <td title="${r.body?esc(r.body):''}">${r.title?'<strong>'+esc(r.title)+'</strong> ‚Äî ':''}${preview}</td>
      <td style="color:var(--ac)">${listing}</td>
      <td><span class="badge-s b-${st}">${st}</span></td>
      <td style="white-space:nowrap">${st==='pending'
        ?`<button class="su-btn su-approve" onclick="approveReview(${r.id},${r.listing_id})">Approve</button> <button class="su-btn su-reject" onclick="rejectReview(${r.id})">Reject</button>`
        :st==='approved'?`<button class="su-btn su-reject" onclick="rejectReview(${r.id})">Reject</button>`:''
      }</td>
    </tr>`;
  }).join('');
}

async function approveReview(id,listingId){
  await SB.from('reviews').update({status:'approved'}).eq('id',id);
  const r=allReviews.find(x=>x.id===id);
  if(r)r.status='approved';
  // Recalculate listing avg_rating and review_count
  const approvedForListing=allReviews.filter(x=>x.listing_id===listingId&&x.status==='approved');
  const avg=approvedForListing.length?(approvedForListing.reduce((s,x)=>s+x.rating,0)/approvedForListing.length).toFixed(1):null;
  const cnt=approvedForListing.length;
  await SB.from('listings').update({avg_rating:avg,review_count:cnt}).eq('id',listingId);
  document.getElementById('cntReviews').textContent=allReviews.filter(x=>x.status==='pending').length;
  renderReviews();
}

async function rejectReview(id){
  await SB.from('reviews').update({status:'rejected'}).eq('id',id);
  const r=allReviews.find(x=>x.id===id);
  if(r)r.status='rejected';
  document.getElementById('cntReviews').textContent=allReviews.filter(x=>x.status==='pending').length;
  renderReviews();
}

// ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ
function esc(s){if(!s)return'';const d=document.createElement('div');d.textContent=s;return d.innerHTML;}

// Close on Escape
document.addEventListener('keydown',e=>{
  if(e.key==='Escape'){closePanel();closeConfirm();closeMenus();}
});
</script>
</body>
</html>
