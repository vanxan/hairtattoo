<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="robots" content="noindex, nofollow">
<title>Dashboard ‚Äî Hair Tattoo</title>
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üíà</text></svg>">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,700&family=Instrument+Serif:ital@0;1&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#FAFAF8;--card:#FFF;--text:#1A1A1A;--t2:#555;--t3:#888;--ac:#2D5A3D;--ac2:#3A7350;--al:#E8F0EB;--bd:#E8E6E3;--sh:0 1px 3px rgba(0,0,0,.06);--r:12px;--rs:8px;--f:'DM Sans',system-ui,sans-serif;--se:'Instrument Serif',Georgia,serif}
html{font-size:16px}
body{font-family:var(--f);background:var(--bg);color:var(--text);line-height:1.5;-webkit-font-smoothing:antialiased}
a{color:var(--ac);text-decoration:none}
button{font-family:var(--f);cursor:pointer;border:none;background:none}
input,textarea,select{font-family:var(--f);font-size:1rem}

.nav{position:sticky;top:0;z-index:100;background:rgba(250,250,248,.92);backdrop-filter:blur(12px);border-bottom:1px solid var(--bd);padding:0 1rem}
.nav-in{max-width:1200px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;height:56px}
.logo{font-family:var(--se);font-size:1.5rem;color:var(--text);letter-spacing:-.02em;cursor:pointer}
.logo span{color:var(--ac)}
.nav-r{display:flex;gap:.75rem;align-items:center}
.nav-r a{color:var(--t2);font-size:.875rem;font-weight:500;transition:color .15s}
.nav-r a:hover{color:var(--ac)}
.btn{display:inline-flex;align-items:center;gap:.5rem;padding:.5rem 1rem;border-radius:var(--rs);font-size:.875rem;font-weight:500;transition:all .15s}
.btn-p{background:var(--ac);color:#fff}.btn-p:hover{background:var(--ac2)}
.btn-o{border:1px solid var(--bd);color:var(--text)}.btn-o:hover{border-color:var(--ac);color:var(--ac)}
.btn-sm{padding:.375rem .75rem;font-size:.8125rem}

/* LOADING & EMPTY */
.dash-loading{display:flex;align-items:center;justify-content:center;min-height:60vh;color:var(--t3);font-size:.875rem}
.dash-empty{max-width:480px;margin:4rem auto;text-align:center;padding:2rem}
.dash-empty h2{font-size:1.25rem;margin-bottom:.5rem}
.dash-empty p{color:var(--t2);font-size:.875rem;margin-bottom:1.5rem}

/* LAYOUT */
.dash{display:flex;max-width:1200px;margin:0 auto;min-height:calc(100vh - 57px)}
.sidebar{width:220px;border-right:1px solid var(--bd);padding:1.5rem 0;flex-shrink:0}
.sb-link{display:flex;align-items:center;gap:.625rem;padding:.625rem 1.25rem;font-size:.875rem;color:var(--t2);font-weight:500;transition:all .15s;cursor:pointer;border-left:3px solid transparent}
.sb-link:hover{color:var(--text);background:var(--al)}
.sb-link.on{color:var(--ac);border-left-color:var(--ac);background:var(--al);font-weight:600}
.sb-user{padding:1rem 1.25rem;border-bottom:1px solid var(--bd);margin-bottom:.5rem;display:flex;align-items:center;gap:.625rem}
.sb-av{width:36px;height:36px;border-radius:50%;background:var(--al);display:flex;align-items:center;justify-content:center;font-size:.8125rem;font-weight:700;color:var(--ac);flex-shrink:0}
.sb-name{font-size:.8125rem;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.sb-email{font-size:.75rem;color:var(--t2);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.sb-badge{background:var(--ac);color:#fff;font-size:.625rem;padding:.125rem .375rem;border-radius:10px;margin-left:auto}
.dash-main{flex:1;padding:1.5rem 2rem;min-width:0}
.dtab{display:none}.dtab.active{display:block}
.dtab h2{font-size:1.25rem;font-weight:700;margin-bottom:1.25rem}

/* FORM */
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:.75rem 1rem}
.form-grid.full{grid-template-columns:1fr}
.fg{display:flex;flex-direction:column}
.fg label{font-size:.75rem;font-weight:600;color:var(--t3);text-transform:uppercase;letter-spacing:.04em;margin-bottom:.25rem}
.fg input,.fg textarea,.fg select{padding:.625rem .75rem;border:1px solid var(--bd);border-radius:var(--rs);outline:none;font-size:.875rem;background:#fff;transition:border-color .15s}
.fg input:focus,.fg textarea:focus,.fg select:focus{border-color:var(--ac)}
.fg textarea{resize:vertical;min-height:100px}
.form-actions{display:flex;gap:.75rem;align-items:center;margin-top:1.25rem;padding-top:1.25rem;border-top:1px solid var(--bd)}
.form-actions .saved{font-size:.8125rem;color:var(--ac);font-weight:500;display:none}
.svc-checks{display:flex;flex-wrap:wrap;gap:.375rem;margin-bottom:.75rem}
.svc-check{font-size:.75rem;padding:.25rem .625rem;border:1px solid var(--bd);border-radius:20px;cursor:pointer;transition:all .15s;background:var(--card);color:var(--t2)}
.svc-check.on{border-color:var(--ac);background:var(--al);color:var(--ac)}

/* STAT CARDS */
.stats{display:grid;grid-template-columns:repeat(4,1fr);gap:.75rem;margin-bottom:1.5rem}
.stat{background:var(--card);border:1px solid var(--bd);border-radius:var(--r);padding:1rem}
.stat-label{font-size:.6875rem;text-transform:uppercase;letter-spacing:.06em;color:var(--t3);font-weight:600;margin-bottom:.25rem}
.stat-val{font-size:1.5rem;font-weight:700;color:var(--text)}
.stat-change{font-size:.6875rem;margin-top:.25rem;font-weight:500}
.stat-up{color:#059669}.stat-down{color:#DC2626}.stat-flat{color:var(--t3)}
.stat-bar{height:6px;background:var(--bd);border-radius:3px;margin-top:.5rem;overflow:hidden}
.stat-bar-fill{height:100%;background:var(--ac);border-radius:3px;transition:width .5s}

/* BAR CHART */
.chart-wrap{background:var(--card);border:1px solid var(--bd);border-radius:var(--r);padding:1.25rem;margin-bottom:1.5rem}
.chart-wrap h3{font-size:.8125rem;font-weight:600;color:var(--text);margin-bottom:1rem}
.chart{display:flex;align-items:flex-end;gap:2px;height:140px;padding-top:.5rem}
.chart-col{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:flex-end;height:100%}
.chart-bar{width:100%;background:var(--ac);border-radius:3px 3px 0 0;min-height:2px;transition:height .3s ease}
.chart-label{font-size:.5rem;color:var(--t3);margin-top:.25rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:100%}
.chart-none{color:var(--t3);font-size:.8125rem;text-align:center;padding:2rem 0}

/* DATE RANGE */
.date-range{display:flex;gap:.375rem;margin-bottom:1rem}
.dr-btn{padding:.375rem .75rem;border:1px solid var(--bd);border-radius:20px;font-size:.75rem;font-weight:500;cursor:pointer;background:var(--card);color:var(--t2);transition:all .15s}
.dr-btn:hover{border-color:var(--ac);color:var(--ac)}
.dr-btn.on{background:var(--ac);color:#fff;border-color:var(--ac)}

/* NUDGE CARDS */
.nudges{display:grid;grid-template-columns:1fr 1fr;gap:.75rem;margin-bottom:1.5rem}
.nudge{background:var(--card);border:1px solid var(--bd);border-radius:var(--r);padding:1rem;cursor:pointer;transition:all .15s}
.nudge:hover{border-color:var(--ac);box-shadow:var(--sh)}
.nudge h4{font-size:.8125rem;font-weight:600;margin-bottom:.25rem}
.nudge p{font-size:.75rem;color:var(--t2);line-height:1.4}

/* ACTIVITY TIMELINE */
.timeline{display:flex;flex-direction:column;gap:0;margin-bottom:1.5rem}
.tl-item{display:flex;align-items:flex-start;gap:.75rem;padding:.75rem 0;border-bottom:1px solid var(--bd)}
.tl-item:last-child{border-bottom:none}
.tl-icon{width:32px;height:32px;border-radius:50%;background:var(--al);display:flex;align-items:center;justify-content:center;font-size:.875rem;flex-shrink:0}
.tl-text{flex:1;font-size:.8125rem;color:var(--t2);line-height:1.4}
.tl-text strong{color:var(--text)}
.tl-time{font-size:.6875rem;color:var(--t3);white-space:nowrap}

/* QUICK ACTIONS */
.quick-actions{display:flex;gap:.75rem;margin-bottom:1.5rem;flex-wrap:wrap}

/* LEADS CRM */
.leads-layout{display:grid;grid-template-columns:320px 1fr;gap:0;background:var(--card);border:1px solid var(--bd);border-radius:var(--r);overflow:hidden;min-height:500px}
.leads-list{border-right:1px solid var(--bd);overflow-y:auto;max-height:600px}
.leads-filters{display:flex;gap:0;border-bottom:1px solid var(--bd);padding:0 .75rem;background:var(--bg)}
.lf-btn{padding:.625rem .75rem;font-size:.75rem;font-weight:500;color:var(--t3);cursor:pointer;border-bottom:2px solid transparent;transition:all .15s}
.lf-btn:hover{color:var(--t2)}
.lf-btn.on{color:var(--ac);border-bottom-color:var(--ac)}
.lead-row{display:flex;align-items:center;gap:.625rem;padding:.75rem 1rem;cursor:pointer;transition:background .1s;border-bottom:1px solid var(--bd)}
.lead-row:hover{background:var(--al)}
.lead-row.on{background:var(--al)}
.lead-dot{width:8px;height:8px;border-radius:50%;background:var(--ac);flex-shrink:0}
.lead-dot.read{background:transparent}
.lead-info{flex:1;min-width:0}
.lead-name{font-size:.8125rem;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.lead-preview{font-size:.75rem;color:var(--t3);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.lead-date{font-size:.6875rem;color:var(--t3);white-space:nowrap}
.lead-status{font-size:.625rem;padding:.125rem .375rem;border-radius:4px;font-weight:600;text-transform:uppercase}
.ls-new{background:#DBEAFE;color:#1D4ED8}
.ls-contacted{background:#FEF3C7;color:#92400E}
.ls-booked{background:#D1FAE5;color:#065F46}
.ls-completed{background:var(--al);color:var(--ac)}
.ls-archived{background:var(--bg);color:var(--t3)}
.lead-detail{padding:1.5rem}
.lead-detail-empty{display:flex;align-items:center;justify-content:center;color:var(--t3);font-size:.875rem;height:100%}
.ld-name{font-size:1.125rem;font-weight:700;margin-bottom:.5rem}
.ld-meta{display:flex;gap:1rem;margin-bottom:1rem;flex-wrap:wrap}
.ld-meta a,.ld-meta span{font-size:.8125rem;color:var(--t2);display:flex;align-items:center;gap:.25rem}
.ld-pills{display:flex;flex-wrap:wrap;gap:.375rem;margin-bottom:1rem}
.ld-pill{font-size:.6875rem;padding:.25rem .5rem;border-radius:20px;background:var(--al);color:var(--ac)}
.ld-msg{font-size:.875rem;color:var(--text);line-height:1.6;padding:1rem;background:var(--bg);border-radius:var(--rs);margin-bottom:1rem;white-space:pre-wrap}
.ld-actions{display:flex;gap:.5rem;align-items:center;flex-wrap:wrap;margin-bottom:1rem}
.ld-notes textarea{width:100%;padding:.625rem .75rem;border:1px solid var(--bd);border-radius:var(--rs);font-size:.8125rem;resize:vertical;min-height:60px;outline:none}
.ld-notes textarea:focus{border-color:var(--ac)}

/* PORTFOLIO */
.upload-zone{border:2px dashed var(--bd);border-radius:var(--r);padding:2rem;text-align:center;cursor:pointer;transition:all .15s;margin-bottom:1.5rem;background:var(--card)}
.upload-zone:hover,.upload-zone.dragover{border-color:var(--ac);background:var(--al)}
.upload-zone p{font-size:.875rem;color:var(--t2);margin-top:.5rem}
.upload-zone .hint{font-size:.75rem;color:var(--t3);margin-top:.25rem}
.upload-progress{display:none;margin-bottom:1rem}
.upload-bar{height:6px;background:var(--bd);border-radius:3px;overflow:hidden}
.upload-bar-fill{height:100%;background:var(--ac);border-radius:3px;transition:width .3s;width:0}
.media-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:.75rem;margin-bottom:1.5rem}
.media-item{position:relative;border-radius:var(--rs);overflow:hidden;border:1px solid var(--bd);background:var(--card);cursor:pointer;transition:box-shadow .15s}
.media-item:hover{box-shadow:0 2px 8px rgba(0,0,0,.1)}
.media-item img,.media-item video{width:100%;height:160px;object-fit:cover;display:block}
.media-del{position:absolute;top:.375rem;right:.375rem;width:24px;height:24px;border-radius:50%;background:rgba(0,0,0,.6);color:#fff;display:flex;align-items:center;justify-content:center;font-size:.75rem;cursor:pointer;opacity:0;transition:opacity .15s}
.media-item:hover .media-del{opacity:1}
.media-pill{position:absolute;bottom:.375rem;left:.375rem;font-size:.6875rem;padding:.125rem .5rem;border-radius:4px;background:rgba(0,0,0,.6);color:#fff}
.media-play{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:48px;height:48px;border-radius:50%;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;pointer-events:none}
.media-play::after{content:'';display:block;width:0;height:0;border-style:solid;border-width:10px 0 10px 18px;border-color:transparent transparent transparent #fff;margin-left:3px}
.tips-card{background:var(--al);border:1px solid #c8dbd0;border-radius:var(--r);padding:1rem;margin-bottom:1.5rem}
.tips-card h4{font-size:.8125rem;font-weight:600;color:var(--ac);margin-bottom:.375rem}
.tips-card p{font-size:.75rem;color:var(--t2);line-height:1.5}
.placeholder-banner{background:#FEF3C7;border:1px solid #FDE68A;border-radius:var(--r);padding:.75rem 1rem;margin-bottom:1rem;font-size:.8125rem;color:#92400E;display:flex;align-items:center;gap:.5rem}
.video-modal{display:none;position:fixed;inset:0;z-index:400;background:rgba(0,0,0,.92);justify-content:center;align-items:center;flex-direction:column;padding:1rem}
.video-modal.open{display:flex}
.video-modal video{max-width:90vw;max-height:80vh;border-radius:8px;background:#000}
.video-modal .vm-close{position:absolute;top:1rem;right:1rem;width:40px;height:40px;border-radius:50%;background:rgba(255,255,255,.1);color:#fff;font-size:1.5rem;display:flex;align-items:center;justify-content:center;cursor:pointer}
.video-modal .vm-close:hover{background:rgba(255,255,255,.2)}

/* REVIEWS */
.review-stats{display:flex;align-items:center;gap:1.5rem;padding:1.25rem;background:var(--card);border:1px solid var(--bd);border-radius:var(--r);margin-bottom:1.5rem}
.rs-big{text-align:center}
.rs-num{font-size:2rem;font-weight:700;color:var(--text);line-height:1}
.rs-stars{color:#F59E0B;font-size:1.125rem;margin-top:.25rem}
.rs-count{font-size:.75rem;color:var(--t3);margin-top:.25rem}
.rs-breakdown{flex:1}
.rs-row{display:flex;align-items:center;gap:.5rem;margin-bottom:.25rem}
.rs-row span:first-child{font-size:.75rem;color:var(--t2);width:16px;text-align:right}
.rs-bar{flex:1;height:8px;background:var(--bd);border-radius:4px;overflow:hidden}
.rs-bar-fill{height:100%;background:#F59E0B;border-radius:4px}
.rs-row span:last-child{font-size:.6875rem;color:var(--t3);width:30px}
.review-list{display:flex;flex-direction:column;gap:.75rem;margin-bottom:1.5rem}
.review-item{background:var(--card);border:1px solid var(--bd);border-radius:var(--r);padding:1rem}
.ri-head{display:flex;align-items:center;gap:.75rem;margin-bottom:.5rem}
.ri-name{font-size:.875rem;font-weight:600;flex:1}
.ri-date{font-size:.75rem;color:var(--t3)}
.ri-stars{color:#F59E0B;font-size:.875rem}
.ri-title{font-size:.875rem;font-weight:600;margin-bottom:.25rem}
.ri-body{font-size:.8125rem;color:var(--t2);line-height:1.5}
.ri-reply{margin-top:.75rem;padding:.75rem;background:var(--bg);border-radius:var(--rs);border-left:3px solid var(--ac)}
.ri-reply label{font-size:.6875rem;font-weight:600;color:var(--ac);text-transform:uppercase;display:block;margin-bottom:.25rem}
.ri-reply p{font-size:.8125rem;color:var(--t2);line-height:1.4}
.ri-reply-form{margin-top:.75rem}
.ri-reply-form textarea{width:100%;padding:.5rem .75rem;border:1px solid var(--bd);border-radius:var(--rs);font-size:.8125rem;resize:vertical;min-height:60px;outline:none}
.ri-reply-form textarea:focus{border-color:var(--ac)}
.ri-pending{font-size:.6875rem;color:#92400E;background:#FEF3C7;padding:.125rem .5rem;border-radius:4px;margin-left:.5rem}

/* INSIGHTS */
.funnel{display:flex;align-items:center;gap:.5rem;padding:1rem;background:var(--card);border:1px solid var(--bd);border-radius:var(--r);margin-bottom:1.5rem;overflow-x:auto}
.funnel-step{text-align:center;flex:1;min-width:80px}
.funnel-num{font-size:1.25rem;font-weight:700}
.funnel-label{font-size:.6875rem;color:var(--t3);text-transform:uppercase}
.funnel-arrow{color:var(--bd);font-size:1.5rem}
.weekly-summary{background:var(--card);border:1px solid var(--bd);border-radius:var(--r);padding:1.25rem;margin-bottom:1.5rem}
.weekly-summary h3{font-size:.8125rem;font-weight:600;margin-bottom:.75rem}
.ws-row{display:flex;gap:1.5rem;font-size:.875rem;color:var(--t2)}
.ws-item{display:flex;align-items:center;gap:.375rem}

/* BOOKING */
.booking-setup{background:var(--card);border:1px solid var(--bd);border-radius:var(--r);padding:1.5rem;margin-bottom:1.5rem}
.booking-setup h3{font-size:.875rem;font-weight:600;margin-bottom:1rem}
.booking-type{display:flex;gap:.75rem;margin-bottom:1rem}
.bt-option{flex:1;padding:1rem;border:2px solid var(--bd);border-radius:var(--r);cursor:pointer;text-align:center;transition:all .15s}
.bt-option:hover{border-color:var(--ac)}
.bt-option.on{border-color:var(--ac);background:var(--al)}
.bt-option h4{font-size:.8125rem;font-weight:600;margin-bottom:.25rem}
.bt-option p{font-size:.75rem;color:var(--t2)}
.booking-stat{display:flex;align-items:center;gap:1rem;padding:1rem;background:var(--al);border-radius:var(--r);margin-bottom:1rem}
.booking-stat .stat-val{font-size:1.25rem}

/* PRO GATING */
.sb-pro{font-size:.5625rem;font-weight:700;padding:.0625rem .3rem;border-radius:4px;background:#F3E8FF;color:#7C3AED;margin-left:auto;text-transform:uppercase;letter-spacing:.03em}
.sb-lock{opacity:.55}
.upgrade-banner{background:linear-gradient(135deg,#F3E8FF,#EDE9FE);border:1px solid #DDD6FE;border-radius:var(--r);padding:1.25rem;margin-bottom:1.5rem;text-align:center}
.upgrade-banner h3{font-size:.9375rem;font-weight:700;color:#5B21B6;margin-bottom:.375rem}
.upgrade-banner p{font-size:.8125rem;color:#6D28D9;margin-bottom:1rem;line-height:1.5}
.upgrade-banner .btn-pro{display:inline-flex;align-items:center;gap:.375rem;padding:.625rem 1.5rem;border-radius:var(--rs);font-size:.875rem;font-weight:600;background:var(--bd);color:var(--t3);cursor:default;border:none}
.sms-banner{background:#FFF7ED;border:1px solid #FED7AA;border-radius:var(--r);padding:1rem;margin-bottom:1.5rem;display:flex;align-items:center;gap:.75rem}
.sms-banner-icon{font-size:1.25rem;flex-shrink:0}
.sms-banner-text{flex:1}
.sms-banner-text strong{font-size:.8125rem;display:block;color:#9A3412;margin-bottom:.125rem}
.sms-banner-text span{font-size:.75rem;color:#C2410C}
.upload-limit-msg{background:#FEF3C7;border:1px solid #FDE68A;border-radius:var(--r);padding:1rem;margin-bottom:1rem;text-align:center;font-size:.8125rem;color:#92400E}
.upload-limit-msg strong{display:block;margin-bottom:.25rem}

/* MOBILE MENU TOGGLE */
.mob-toggle{display:none;position:fixed;bottom:1rem;right:1rem;width:48px;height:48px;border-radius:50%;background:var(--ac);color:#fff;z-index:99;align-items:center;justify-content:center;font-size:1.25rem;box-shadow:0 2px 8px rgba(0,0,0,.2)}

@media(max-width:768px){
  .dash{flex-direction:column}
  .sidebar{width:100%;border-right:none;border-bottom:1px solid var(--bd);padding:.5rem 0;overflow-x:auto;display:flex}
  .sb-user{display:none}
  .sb-link{border-left:none;border-bottom:2px solid transparent;white-space:nowrap;padding:.5rem .75rem;font-size:.8125rem}
  .sb-link.on{border-left-color:transparent;border-bottom-color:var(--ac)}
  .sb-badge{margin-left:.25rem}
  .dash-main{padding:1rem}
  .form-grid{grid-template-columns:1fr}
  .stats{grid-template-columns:1fr 1fr}
  .nudges{grid-template-columns:1fr}
  .leads-layout{grid-template-columns:1fr}
  .leads-list{max-height:300px;border-right:none;border-bottom:1px solid var(--bd)}
  .lead-detail{padding:1rem}
  .review-stats{flex-direction:column;text-align:center}
  .quick-actions{flex-direction:column}
  .quick-actions .btn{justify-content:center}
}
</style>
</head>
<body>

<nav class="nav"><div class="nav-in">
  <a href="/" class="logo">Hair<span>Tattoo</span></a>
  <div class="nav-r">
    <a href="/">Directory</a>
    <button class="btn btn-o" id="logoutBtn" onclick="doLogout()" style="display:none">Log Out</button>
  </div>
</div></nav>

<div class="dash-loading" id="dashLoading">Loading your dashboard...</div>

<div class="dash-empty" id="dashEmpty" style="display:none">
  <h2>No listing found</h2>
  <p>We couldn't find a listing linked to your account. Create or claim a listing to manage it from here.</p>
  <a href="/signup.html" class="btn btn-p">Create Your Listing</a>
</div>

<div class="dash" id="dashContent" style="display:none">
  <aside class="sidebar" id="sidebar">
    <div class="sb-user">
      <div class="sb-av" id="sbAvatar"></div>
      <div>
        <div class="sb-name" id="sbName"></div>
        <div class="sb-email" id="sbEmail"></div>
      </div>
    </div>
    <a class="sb-link on" data-tab="overview" onclick="showTab('overview')">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
      Overview
    </a>
    <a class="sb-link" data-tab="leads" onclick="showTab('leads')">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
      Leads
      <span class="sb-badge" id="leadsBadge" style="display:none"></span>
    </a>
    <a class="sb-link" data-tab="portfolio" onclick="showTab('portfolio')">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="m21 15-5-5L5 21"/></svg>
      Portfolio
    </a>
    <a class="sb-link" data-tab="reviews" onclick="showTab('reviews')">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
      Reviews
    </a>
    <a class="sb-link" data-tab="insights" onclick="showTab('insights')">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
      Insights
    </a>
    <a class="sb-link" data-tab="settings" onclick="showTab('settings')">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
      Settings
    </a>
    <a class="sb-link" data-tab="booking" onclick="showTab('booking')">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
      Booking
    </a>
    <a class="sb-link sb-lock" data-tab="marketplace" onclick="showTab('marketplace')">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
      Marketplace
      <span class="sb-pro">PRO</span>
    </a>
  </aside>

  <main class="dash-main">

    <!-- TAB 1: OVERVIEW -->
    <div id="dtab-overview" class="dtab active">
      <h2>Overview</h2>
      <div class="stats" id="overviewStats"></div>
      <div class="nudges" id="nudges"></div>
      <div class="quick-actions">
        <a class="btn btn-p" id="qaViewListing" href="#" target="_blank">View My Listing</a>
        <button class="btn btn-o" onclick="copyListingUrl()">Share My Page</button>
        <button class="btn btn-o" onclick="showTab('reviews')">Get Reviews</button>
      </div>
      <div class="chart-wrap">
        <h3>Recent Activity</h3>
        <div class="timeline" id="activityTimeline"><div class="chart-none">Loading...</div></div>
      </div>
    </div>

    <!-- TAB 2: LEADS -->
    <div id="dtab-leads" class="dtab">
      <h2>Leads</h2>
      <div class="sms-banner">
        <div class="sms-banner-icon">üì±</div>
        <div class="sms-banner-text">
          <strong>Get instant SMS notifications for new leads</strong>
          <span>Pro members receive real-time text alerts when a new lead comes in. Never miss a client again.</span>
        </div>
        <span class="sb-pro" style="font-size:.625rem;white-space:nowrap">PRO</span>
      </div>
      <div class="leads-layout">
        <div class="leads-list">
          <div class="leads-filters">
            <span class="lf-btn on" data-filter="all" onclick="setLeadFilter('all',this)">All</span>
            <span class="lf-btn" data-filter="new" onclick="setLeadFilter('new',this)">New</span>
            <span class="lf-btn" data-filter="contacted" onclick="setLeadFilter('contacted',this)">Contacted</span>
            <span class="lf-btn" data-filter="booked" onclick="setLeadFilter('booked',this)">Booked</span>
            <span class="lf-btn" data-filter="completed" onclick="setLeadFilter('completed',this)">Done</span>
          </div>
          <div id="leadsList"></div>
        </div>
        <div class="lead-detail" id="leadDetail">
          <div class="lead-detail-empty">Select a lead to view details</div>
        </div>
      </div>
    </div>

    <!-- TAB 3: PORTFOLIO -->
    <div id="dtab-portfolio" class="dtab">
      <h2>Portfolio</h2>
      <div class="placeholder-banner" id="placeholderBanner" style="display:none">
        Your listing is showing sample photos. Upload your own work to attract more clients.
      </div>
      <div class="upload-limit-msg" id="uploadLimitMsg" style="display:none">
        <strong>Free plan limit reached (6 uploads)</strong>
        Upgrade to Pro for unlimited media uploads.
      </div>
      <div class="upload-zone" id="uploadZone" onclick="document.getElementById('fileInput').click()">
        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
        <p>Drop photos or videos here, or click to browse</p>
        <span class="hint">JPEG, PNG, WebP, HEIC (10MB max) &middot; MP4, MOV, WebM (50MB max)</span>
        <input type="file" id="fileInput" style="display:none" multiple accept="image/*,video/*" onchange="handleUpload(this.files)">
      </div>
      <div class="upload-progress" id="uploadProgress">
        <div class="upload-bar"><div class="upload-bar-fill" id="uploadBarFill"></div></div>
        <p style="font-size:.75rem;color:var(--t3);margin-top:.25rem" id="uploadStatus">Uploading...</p>
      </div>
      <div class="media-grid" id="mediaGrid"></div>
      <div class="tips-card">
        <h4>Tips for great SMP photos</h4>
        <p>Use natural lighting, shoot from multiple angles, include close-ups of hairline work. Before &amp; after pairs get the most engagement.</p>
      </div>
    </div>

    <!-- TAB 4: REVIEWS -->
    <div id="dtab-reviews" class="dtab">
      <h2>Reviews</h2>
      <div class="review-stats" id="reviewStats"></div>

      <!-- Review link share -->
      <div style="background:var(--card);border:1px solid var(--bd);border-radius:var(--r);padding:1.25rem;margin-bottom:1.5rem">
        <h3 style="font-size:.875rem;font-weight:600;margin-bottom:.5rem">Share your review link</h3>
        <p style="font-size:.8125rem;color:var(--t2);margin-bottom:.75rem">Send this link to past clients so they can leave a review.</p>
        <div style="display:flex;gap:.5rem;align-items:center">
          <input type="text" id="reviewLinkInput" readonly style="flex:1;padding:.5rem .75rem;border:1px solid var(--bd);border-radius:var(--rs);font-size:.8125rem;background:var(--bg);color:var(--text);cursor:text" value="">
          <button class="btn btn-p" id="copyReviewLink" onclick="copyReviewLink()">Copy Link</button>
        </div>
      </div>

      <p style="font-size:.75rem;color:var(--t3);margin-bottom:1rem">New reviews are published after a quick verification.</p>
      <div class="review-list" id="reviewList"><div class="chart-none">Loading reviews...</div></div>
    </div>

    <!-- TAB 5: INSIGHTS -->
    <div id="dtab-insights" class="dtab">
      <h2>Insights</h2>
      <div class="date-range" id="insightsRange">
        <span class="dr-btn" onclick="setDateRange(7,this)">7 days</span>
        <span class="dr-btn on" onclick="setDateRange(30,this)">30 days</span>
        <span class="dr-btn" onclick="setDateRange(90,this)">90 days</span>
        <span class="dr-btn" onclick="setDateRange(0,this)">All time</span>
      </div>
      <div class="stats" id="insightsStats"></div>
      <div class="chart-wrap">
        <h3>Profile Views</h3>
        <div class="chart" id="viewsChart"><div class="chart-none">Loading...</div></div>
      </div>
      <div class="funnel" id="leadFunnel"></div>
      <div class="weekly-summary" id="weeklySummary"></div>
    </div>

    <!-- TAB 6: SETTINGS -->
    <div id="dtab-settings" class="dtab">
      <h2>Settings</h2>

      <!-- Profile Photo -->
      <div style="background:var(--card);border:1px solid var(--bd);border-radius:var(--r);padding:1.25rem;margin-bottom:1.5rem;display:flex;align-items:center;gap:1.25rem">
        <div id="profilePhotoPreview" style="width:72px;height:72px;border-radius:50%;background:var(--al);display:flex;align-items:center;justify-content:center;font-size:1.25rem;font-weight:700;color:var(--ac);flex-shrink:0;overflow:hidden">
          <span id="profileInitials"></span>
        </div>
        <div style="flex:1">
          <div style="font-size:.875rem;font-weight:600;margin-bottom:.375rem">Profile Photo</div>
          <p style="font-size:.75rem;color:var(--t2);margin-bottom:.625rem">This appears on your listing and in search results.</p>
          <div style="display:flex;gap:.5rem">
            <button class="btn btn-o btn-sm" onclick="document.getElementById('profilePhotoInput').click()">Upload Photo</button>
            <button class="btn btn-sm" id="removeProfilePhoto" style="color:#DC2626;border:1px solid #FCA5A5;display:none" onclick="removeProfilePhoto()">Remove</button>
            <input type="file" id="profilePhotoInput" style="display:none" accept="image/jpeg,image/png,image/webp" onchange="uploadProfilePhoto(this.files)">
          </div>
          <div id="profilePhotoMsg" style="font-size:.75rem;margin-top:.375rem"></div>
        </div>
      </div>

      <h3 style="font-size:.875rem;font-weight:600;margin-bottom:1rem">Business Information</h3>
      <div class="form-grid">
        <div class="fg"><label>Business Name</label><input type="text" id="fName"></div>
        <div class="fg"><label>Price Range</label>
          <select id="fPrice"><option value="$">$ ‚Äî Budget</option><option value="$$" selected>$$ ‚Äî Standard</option><option value="$$$">$$$ ‚Äî Premium</option><option value="$$$$">$$$$ ‚Äî Luxury</option></select>
        </div>
        <div class="fg"><label>Address</label><input type="text" id="fAddress"></div>
        <div class="fg"><label>City</label><input type="text" id="fCity"></div>
        <div class="fg"><label>State</label><input type="text" id="fState"></div>
        <div class="fg"><label>ZIP Code</label><input type="text" id="fZip"></div>
        <div class="fg"><label>Phone</label><input type="tel" id="fPhone"></div>
        <div class="fg"><label>Email</label><input type="email" id="fEmail"></div>
        <div class="fg"><label>Website</label><input type="url" id="fWebsite"></div>
      </div>
      <div class="form-grid full" style="margin-top:.75rem">
        <div class="fg"><label>About / Description</label><textarea id="fAbout" rows="4"></textarea></div>
      </div>
      <div style="margin-top:.75rem">
        <label style="font-size:.75rem;font-weight:600;color:var(--t3);text-transform:uppercase;letter-spacing:.04em;display:block;margin-bottom:.375rem">Services Offered</label>
        <div class="svc-checks" id="fServices">
          <span class="svc-check" onclick="this.classList.toggle('on')">Hairline Restoration</span>
          <span class="svc-check" onclick="this.classList.toggle('on')">Density Fill</span>
          <span class="svc-check" onclick="this.classList.toggle('on')">Scar Camouflage</span>
          <span class="svc-check" onclick="this.classList.toggle('on')">Female SMP</span>
          <span class="svc-check" onclick="this.classList.toggle('on')">Beard SMP</span>
          <span class="svc-check" onclick="this.classList.toggle('on')">Alopecia Treatment</span>
          <span class="svc-check" onclick="this.classList.toggle('on')">3D SMP</span>
          <span class="svc-check" onclick="this.classList.toggle('on')">Custom</span>
        </div>
      </div>

      <h3 style="font-size:.875rem;font-weight:600;margin:1.5rem 0 1rem">Social Links</h3>
      <div class="form-grid">
        <div class="fg"><label>Instagram Handle</label><input type="text" id="fInstagram" placeholder="@handle"></div>
        <div class="fg"><label>Facebook URL</label><input type="text" id="fFacebook"></div>
        <div class="fg"><label>TikTok Handle</label><input type="text" id="fTiktok" placeholder="@handle"></div>
      </div>

      <h3 style="font-size:.875rem;font-weight:600;margin:1.5rem 0 1rem">Booking Setup</h3>
      <div class="booking-type" id="bookingTypeSelect">
        <div class="bt-option on" data-type="message" onclick="selectBookingType('message')">
          <h4>Message Only</h4>
          <p>Clients contact you via the form</p>
        </div>
        <div class="bt-option" data-type="external" onclick="selectBookingType('external')">
          <h4>External Link</h4>
          <p>Calendly, Square, Booksy, etc.</p>
        </div>
      </div>
      <div class="fg" id="bookingUrlField" style="display:none">
        <label>Booking URL</label>
        <input type="url" id="fBookingUrl" placeholder="https://calendly.com/your-link">
      </div>

      <div class="form-actions">
        <button class="btn btn-p" onclick="saveSettings()">Save All Changes</button>
        <span class="saved" id="settingsSaved">Saved successfully</span>
      </div>

      <h3 style="font-size:.875rem;font-weight:600;margin:2rem 0 1rem">Account</h3>
      <div style="background:var(--card);border:1px solid var(--bd);border-radius:var(--r);padding:1rem">
        <div style="font-size:.8125rem;color:var(--t2);margin-bottom:.75rem">Email: <strong id="accountEmail"></strong></div>
        <div style="display:flex;gap:.5rem">
          <button class="btn btn-o btn-sm" onclick="doLogout()">Log Out</button>
          <button class="btn btn-sm" style="color:#DC2626;border:1px solid #FCA5A5" onclick="archiveListing()">Delete My Listing</button>
        </div>
      </div>
    </div>

    <!-- TAB 7: BOOKING -->
    <div id="dtab-booking" class="dtab">
      <h2>Booking</h2>
      <div class="booking-stat" id="bookingStat">
        <div>
          <div class="stat-label">Booking Clicks This Month</div>
          <div class="stat-val" id="bookingClicks">0</div>
        </div>
      </div>

      <div class="booking-setup" id="bookingContent">
        <h3>Booking Method</h3>
        <div class="booking-type" id="bookingTypeInline">
          <div class="bt-option on" data-type="message" onclick="selectBookingTypeInline('message')">
            <h4>Message Only</h4>
            <p>Clients contact you via the form</p>
          </div>
          <div class="bt-option" data-type="external" onclick="selectBookingTypeInline('external')">
            <h4>External Link</h4>
            <p>Calendly, Square, Booksy, etc.</p>
          </div>
        </div>
        <div class="fg" id="bookingUrlInline" style="display:none;margin-bottom:1rem">
          <label>Booking URL</label>
          <input type="url" id="fBookingUrlInline" placeholder="https://calendly.com/your-link">
        </div>
        <div style="display:flex;gap:.5rem;align-items:center">
          <button class="btn btn-p btn-sm" onclick="saveBooking()">Save Booking Settings</button>
          <span class="saved" id="bookingSaved" style="display:none">Saved!</span>
        </div>
        <div id="bookingPreview" style="margin-top:1.25rem"></div>
      </div>

      <!-- CALENDAR SYNC ‚Äî Coming Soon -->
      <div style="margin-top:1.5rem;background:var(--card);border:1px solid var(--bd);border-radius:var(--r);padding:1.5rem;position:relative;overflow:hidden">
        <div style="display:flex;align-items:flex-start;gap:.375rem;margin-bottom:.5rem">
          <h3 style="font-size:.875rem;font-weight:600">Calendar Sync</h3>
          <span style="font-size:.6875rem;font-weight:600;padding:.125rem .5rem;border-radius:10px;background:#F3E8FF;color:#7C3AED">Pro</span>
        </div>
        <p style="font-size:.8125rem;color:var(--t2);margin-bottom:.75rem">Sync your availability with Google Calendar, Apple Calendar, or Outlook. Show real-time open slots on your listing.</p>
        <button class="btn" style="background:var(--bd);color:var(--t3);cursor:default;padding:.5rem 1.25rem;border-radius:var(--rs);font-size:.8125rem;font-weight:600" disabled>Coming Soon</button>
      </div>

      <!-- PROMOTE YOUR LISTING ‚Äî Coming Soon -->
      <div style="margin-top:1.5rem;background:var(--card);border:1px solid var(--bd);border-radius:var(--r);padding:2rem;position:relative;overflow:hidden">
        <div style="position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,#D4A853,#E8C97A,#D4A853)"></div>
        <div style="display:flex;align-items:flex-start;gap:.375rem;margin-bottom:.75rem">
          <h3 style="font-size:1rem;font-weight:700">Promote Your Listing</h3>
          <span style="font-size:.6875rem;font-weight:600;padding:.125rem .5rem;border-radius:10px;background:#FEF3C7;color:#92400E">Coming Soon</span>
        </div>
        <p style="font-size:.875rem;color:var(--t2);margin-bottom:1.25rem">Get featured at the top of search results in your city. Featured artists get <strong>3x more profile views</strong>.</p>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:.625rem;margin-bottom:1.25rem">
          <div style="display:flex;align-items:center;gap:.5rem;font-size:.8125rem;color:var(--t2)"><span style="color:#D4A853">&#9733;</span> Top placement in your city</div>
          <div style="display:flex;align-items:center;gap:.5rem;font-size:.8125rem;color:var(--t2)"><span style="color:#D4A853">&#9733;</span> Featured Artist badge</div>
          <div style="display:flex;align-items:center;gap:.5rem;font-size:.8125rem;color:var(--t2)"><span style="color:#D4A853">&#9733;</span> Priority in city results</div>
          <div style="display:flex;align-items:center;gap:.5rem;font-size:.8125rem;color:var(--t2)"><span style="color:#D4A853">&#9733;</span> Gold border &amp; featured pill</div>
        </div>
        <button class="btn" style="background:var(--bd);color:var(--t3);cursor:default;padding:.625rem 1.5rem;border-radius:var(--rs);font-weight:600" disabled>Coming Soon ‚Äî $29/month</button>
        <p style="font-size:.75rem;color:var(--t3);margin-top:.75rem">We're launching promoted listings soon. You'll be the first to know.</p>
      </div>
    </div>

    <!-- TAB 8: MARKETPLACE -->
    <div id="dtab-marketplace" class="dtab">
      <h2>SMP Marketplace</h2>
      <div class="upgrade-banner">
        <h3>SMP Products Marketplace</h3>
        <p>Buy and sell SMP equipment, pigments, needles, and supplies directly with other professionals. Available exclusively for Pro members.</p>
        <button class="btn-pro" disabled>Upgrade to Pro ‚Äî Coming Soon</button>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem">
        <div style="background:var(--card);border:1px solid var(--bd);border-radius:var(--r);padding:1.25rem;opacity:.5">
          <h4 style="font-size:.8125rem;font-weight:600;margin-bottom:.25rem">Buy Equipment</h4>
          <p style="font-size:.75rem;color:var(--t2)">Browse SMP machines, pigments, needles, and aftercare products from trusted sellers.</p>
        </div>
        <div style="background:var(--card);border:1px solid var(--bd);border-radius:var(--r);padding:1.25rem;opacity:.5">
          <h4 style="font-size:.8125rem;font-weight:600;margin-bottom:.25rem">Sell Your Products</h4>
          <p style="font-size:.75rem;color:var(--t2)">List your products for sale to the Hair Tattoo community of SMP professionals.</p>
        </div>
      </div>
    </div>

  </main>
</div>

<!-- CONFIRM DIALOG -->
<div id="confirmOverlay" style="display:none;position:fixed;inset:0;z-index:200;background:rgba(0,0,0,.4);align-items:center;justify-content:center">
  <div style="background:var(--card);border-radius:var(--r);padding:1.5rem;max-width:380px;width:100%;text-align:center">
    <h3 style="font-size:1rem;margin-bottom:.5rem">Delete your listing?</h3>
    <p style="font-size:.8125rem;color:var(--t2);margin-bottom:1.25rem">This will archive your listing. It can be restored by contacting support.</p>
    <div style="display:flex;gap:.5rem;justify-content:center">
      <button class="btn btn-o" onclick="document.getElementById('confirmOverlay').style.display='none'">Cancel</button>
      <button class="btn" style="background:#DC2626;color:#fff" onclick="confirmArchive()">Delete</button>
    </div>
  </div>
</div>

<!-- Video player modal -->
<div class="video-modal" id="videoModal" onclick="if(event.target===this)closeVideo()">
  <div class="vm-close" onclick="closeVideo()">&times;</div>
  <video id="videoPlayer" controls playsinline></video>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script>
const SB_URL='https://ingorrzmoudvoknhwjjb.supabase.co';
const SB_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImluZ29ycnptb3Vkdm9rbmh3ampiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA2NDY1NTIsImV4cCI6MjA4NjIyMjU1Mn0.rpcraVuvgRWX1NJtZyUQAzDp4rZhw4cpRm4dRx9yxJc';
const SB=window.supabase.createClient(SB_URL, SB_KEY);

let myListing=null;
let myLeads=[];
let myViews=[];
let myMedia=[];
let myReviews=[];
let currentUser=null;
let loggingOut=false;
let selectedLead=null;
let leadFilter='all';
let insightsDays=30;

function esc(s){if(!s)return'';const d=document.createElement('div');d.textContent=s;return d.innerHTML;}
function ago(d){const s=Math.floor((Date.now()-new Date(d))/1e3);if(s<60)return'just now';if(s<3600)return Math.floor(s/60)+'m ago';if(s<86400)return Math.floor(s/3600)+'h ago';if(s<604800)return Math.floor(s/86400)+'d ago';return new Date(d).toLocaleDateString('en',{month:'short',day:'numeric'});}
function stars(n){return '<span style="color:#F59E0B">'+'&#9733;'.repeat(n)+'</span>'+'<span style="color:var(--bd)">'+'&#9733;'.repeat(5-n)+'</span>';}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê AUTH ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Global error handler ‚Äî catch anything that slips through
window.onerror=function(msg,src,line,col,err){
  console.error('[DASH] Global error:',msg,'at',src,line,col,err);
  const el=document.getElementById('dashLoading');
  if(el&&el.style.display!=='none') el.innerHTML='<div style="color:#DC2626;text-align:center;padding:2rem"><strong>Something went wrong</strong><br><span style="font-size:.75rem">'+msg+'</span><br><br><button class="btn btn-o" onclick="location.reload()">Reload</button></div>';
};
window.onunhandledrejection=function(e){
  console.error('[DASH] Unhandled rejection:',e.reason);
};

// Timeout fallback ‚Äî if still loading after 12s, show error
setTimeout(function(){
  const el=document.getElementById('dashLoading');
  if(el&&el.style.display!=='none'){
    console.error('[DASH] Timeout: dashboard still loading after 12s');
    el.innerHTML='<div style="color:#DC2626;text-align:center;padding:2rem"><strong>Dashboard timed out</strong><br><span style="font-size:.75rem">Could not load your data. Check console (F12) for details.</span><br><br><button class="btn btn-o" onclick="location.reload()">Reload</button></div>';
  }
},12000);

// Use getSession() directly ‚Äî more reliable than onAuthStateChange alone
(async function init(){
  console.log('[DASH] init() starting...');

  // Wait for Supabase to recover session from storage
  const{data:sessionData,error:sessionError}=await SB.auth.getSession();
  console.log('[DASH] getSession result: session=',!!sessionData.session,'error=',sessionError);

  if(!sessionData.session){
    console.log('[DASH] No session found, redirecting to signup');
    window.location.href='/signup.html?from=dashboard';
    return;
  }

  const user=sessionData.session.user;
  currentUser=user;
  document.getElementById('logoutBtn').style.display='';
  console.log('[DASH] Authenticated user:',user.id,user.email);

  // Listen for future auth changes (logout, token refresh)
  SB.auth.onAuthStateChange((event,session)=>{
    console.log('[DASH] onAuthStateChange:',event);
    if(event==='SIGNED_OUT'&&!loggingOut){
      window.location.href='/signup.html?from=dashboard';
    }
  });

  try{
    await loadDashboard(user);
  }catch(err){
    console.error('[DASH] loadDashboard crashed:',err);
    document.getElementById('dashLoading').innerHTML='<div style="color:#DC2626;text-align:center;padding:2rem"><strong>Dashboard error</strong><br><span style="font-size:.75rem">'+esc(err.message)+'</span><br><br><button class="btn btn-o" onclick="location.reload()">Reload</button></div>';
  }
})();

async function doLogout(){
  loggingOut=true;
  await SB.auth.signOut();
  window.location.href='/';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LOAD DASHBOARD ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadDashboard(user){
  console.log('[DASH] loadDashboard() user.id=',user.id,'email=',user.email);
  const email=user.email||'';
  const ini=email.split('@')[0].slice(0,2).toUpperCase();
  document.getElementById('sbAvatar').textContent=ini;
  document.getElementById('sbEmail').textContent=email;
  document.getElementById('accountEmail').textContent=email;

  // Find listing: claimed_by first, then email fallback
  // Use .select() returning array ‚Äî avoids maybeSingle() edge cases
  let listing=null;

  console.log('[DASH] Query 1: listings where claimed_by =',user.id);
  const{data:arr1,error:e1}=await SB.from('listings').select('*').eq('claimed_by',user.id).limit(1);
  console.log('[DASH] Query 1 result: rows=',arr1?arr1.length:null,'error=',e1);
  if(arr1&&arr1.length>0) listing=arr1[0];

  if(!listing&&email){
    console.log('[DASH] Query 2: listings where email ilike',email);
    const{data:arr2,error:e2}=await SB.from('listings').select('*').ilike('email',email).limit(1);
    console.log('[DASH] Query 2 result: rows=',arr2?arr2.length:null,'error=',e2);
    if(arr2&&arr2.length>0){
      listing=arr2[0];
      // Auto-fix: set claimed_by so future loads are faster
      await SB.from('listings').update({claimed_by:user.id,claimed:true}).eq('id',listing.id);
      console.log('[DASH] Auto-claimed listing',listing.id);
    }
  }

  // Hide loading spinner
  document.getElementById('dashLoading').style.display='none';

  if(!listing){
    console.log('[DASH] No listing found ‚Äî showing empty state');
    document.getElementById('dashEmpty').style.display='';
    return;
  }
  console.log('[DASH] Found listing:',listing.id,listing.name,listing.slug);

  myListing=listing;
  document.getElementById('sbName').textContent=listing.name;
  document.getElementById('dashContent').style.display='';

  const cs=listing.city.toLowerCase().replace(/\s+/g,'-')+'-'+listing.state.toLowerCase();
  const liveUrl='/near-me/'+cs+'/'+listing.slug;
  document.getElementById('qaViewListing').href=liveUrl;
  document.getElementById('reviewLinkInput').value='https://hairtattoo.com/review.html?listing='+listing.slug;

  // Load all data in parallel
  console.log('[DASH] Fetching parallel data for listing_id=',listing.id);
  const[viewsRes,leadsRes,mediaRes,reviewsRes]=await Promise.all([
    SB.from('page_views').select('id,created_at').eq('listing_id',listing.id),
    SB.from('leads').select('*').eq('listing_id',listing.id).order('created_at',{ascending:false}),
    SB.from('media').select('*').eq('listing_id',listing.id).order('sort_order',{ascending:true}),
    SB.from('reviews').select('*').eq('listing_id',listing.id).order('created_at',{ascending:false})
  ]);
  console.log('[DASH] Parallel data loaded ‚Äî views:',viewsRes.data?.length,
    'leads:',leadsRes.data?.length,'media:',mediaRes.data?.length,
    'reviews:',reviewsRes.data?.length);
  if(viewsRes.error)console.warn('[DASH] views error:',viewsRes.error);
  if(leadsRes.error)console.warn('[DASH] leads error:',leadsRes.error);
  if(mediaRes.error)console.warn('[DASH] media error:',mediaRes.error);
  if(reviewsRes.error)console.warn('[DASH] reviews error:',reviewsRes.error);

  myViews=viewsRes.data||[];
  myLeads=leadsRes.data||[];
  myMedia=mediaRes.data||[];
  myReviews=reviewsRes.data||[];

  // Show leads badge
  const newLeads=myLeads.filter(l=>!l.status||l.status==='new').length;
  if(newLeads){
    const b=document.getElementById('leadsBadge');
    if(b){b.textContent=newLeads;b.style.display='';}
  }

  console.log('[DASH] Rendering tabs...');
  populateForm(listing);
  renderOverview();
  renderLeads();
  renderPortfolio();
  renderReviews();
  renderInsights();
  renderBooking();
  renderProfilePhoto();
  console.log('[DASH] Dashboard fully loaded!');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TAB 1: OVERVIEW ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderOverview(){
  const now=new Date();
  const ms=new Date(now.getFullYear(),now.getMonth(),1);
  const pms=new Date(now.getFullYear(),now.getMonth()-1,1);

  const monthViews=myViews.filter(v=>new Date(v.created_at)>=ms).length;
  const prevMonthViews=myViews.filter(v=>{const d=new Date(v.created_at);return d>=pms&&d<ms;}).length;
  const monthLeads=myLeads.filter(l=>new Date(l.created_at)>=ms).length;
  const prevMonthLeads=myLeads.filter(l=>{const d=new Date(l.created_at);return d>=pms&&d<ms;}).length;

  const viewChange=prevMonthViews?Math.round(((monthViews-prevMonthViews)/prevMonthViews)*100):0;
  const leadChange=prevMonthLeads?Math.round(((monthLeads-prevMonthLeads)/prevMonthLeads)*100):0;

  const approvedReviews=myReviews.filter(r=>r.status==='approved');
  const avgRating=approvedReviews.length?((approvedReviews.reduce((s,r)=>s+r.rating,0)/approvedReviews.length).toFixed(1)):'‚Äî';

  // Profile completeness
  const l=myListing;
  let pf=0;
  if(l.about)pf++;if(l.phone)pf++;if(l.email)pf++;if(l.website)pf++;
  if(l.services&&l.services.length)pf++;if(l.instagram)pf++;if(l.price_range)pf++;if(l.booking_url)pf++;
  const pfPct=Math.round((pf/8)*100);

  document.getElementById('overviewStats').innerHTML=`
    <div class="stat"><div class="stat-label">Profile Views</div><div class="stat-val">${monthViews}</div><div class="stat-change ${viewChange>=0?'stat-up':'stat-down'}">${viewChange>=0?'+':''}${viewChange}% vs last month</div></div>
    <div class="stat"><div class="stat-label">New Leads</div><div class="stat-val">${monthLeads}</div><div class="stat-change ${leadChange>=0?'stat-up':'stat-down'}">${leadChange>=0?'+':''}${leadChange}% vs last month</div></div>
    <div class="stat"><div class="stat-label">Average Rating</div><div class="stat-val">${avgRating}</div><div style="color:#F59E0B;font-size:.875rem">${approvedReviews.length?stars(Math.round(parseFloat(avgRating))):''}</div></div>
    <div class="stat"><div class="stat-label">Profile Complete</div><div class="stat-val">${pfPct}%</div><div class="stat-bar"><div class="stat-bar-fill" style="width:${pfPct}%"></div></div></div>`;

  // Nudges
  const nudges=[];
  if(!l.booking_url)nudges.push({icon:'üìÖ',title:'Add your booking link',desc:'Get 2x more clients with direct booking',tab:'settings'});
  if(myMedia.filter(m=>!m.is_placeholder).length<10)nudges.push({icon:'üì∏',title:'Upload 10+ photos',desc:'Rank higher in search with a full portfolio',tab:'portfolio'});
  if(!approvedReviews.length)nudges.push({icon:'‚≠ê',title:'Get your first review',desc:'Artists with reviews get 40% more leads',tab:'reviews'});
  if(!l.instagram)nudges.push({icon:'üì±',title:'Add your Instagram',desc:'Connect social media to build trust',tab:'settings'});

  document.getElementById('nudges').innerHTML=nudges.slice(0,4).map(n=>
    `<div class="nudge" onclick="showTab('${n.tab}')"><h4>${n.icon} ${n.title}</h4><p>${n.desc}</p></div>`
  ).join('');

  // Activity timeline
  const events=[];
  myLeads.slice(0,5).forEach(l=>events.push({icon:'üí¨',text:`New lead from <strong>${esc(l.sender_name)}</strong>`,time:l.created_at}));
  myReviews.slice(0,5).forEach(r=>events.push({icon:'‚≠ê',text:`New review from <strong>${esc(r.reviewer_name)}</strong> ‚Äî ${stars(r.rating)}`,time:r.created_at}));
  events.sort((a,b)=>new Date(b.time)-new Date(a.time));

  const tl=document.getElementById('activityTimeline');
  if(!events.length){
    tl.innerHTML='<div class="chart-none">No recent activity. Share your listing to get started!</div>';
  } else {
    tl.innerHTML=events.slice(0,10).map(e=>
      `<div class="tl-item"><div class="tl-icon">${e.icon}</div><div class="tl-text">${e.text}</div><div class="tl-time">${ago(e.time)}</div></div>`
    ).join('');
  }
}

function copyListingUrl(){
  if(!myListing)return;
  const cs=myListing.city.toLowerCase().replace(/\s+/g,'-')+'-'+myListing.state.toLowerCase();
  const url='https://hairtattoo.com/near-me/'+cs+'/'+myListing.slug;
  navigator.clipboard.writeText(url).then(()=>alert('Listing URL copied to clipboard!')).catch(()=>alert(url));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TAB 2: LEADS CRM ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setLeadFilter(f,el){
  leadFilter=f;
  document.querySelectorAll('.lf-btn').forEach(b=>b.classList.toggle('on',b.dataset.filter===f));
  renderLeadsList();
}

function renderLeads(){renderLeadsList();}

function renderLeadsList(){
  const list=document.getElementById('leadsList');
  let filtered=myLeads;
  if(leadFilter!=='all') filtered=filtered.filter(l=>(l.status||'new')===leadFilter);

  if(!filtered.length){
    list.innerHTML='<div class="chart-none" style="padding:2rem">'+
      (leadFilter==='all'?'No leads yet. Make sure your profile is complete and your contact form is working.':'No '+leadFilter+' leads.')+
    '</div>';
    return;
  }

  list.innerHTML=filtered.map((l,i)=>{
    const st=l.status||'new';
    const isNew=st==='new';
    return `<div class="lead-row${selectedLead&&selectedLead.id===l.id?' on':''}" onclick="selectLead(${l.id})">
      <div class="lead-dot${isNew?'':' read'}"></div>
      <div class="lead-info">
        <div class="lead-name">${esc(l.sender_name)}</div>
        <div class="lead-preview">${esc((l.sender_message||'').substring(0,50))}</div>
      </div>
      <div style="text-align:right">
        <div class="lead-date">${ago(l.created_at)}</div>
        <span class="lead-status ls-${st}">${st}</span>
      </div>
    </div>`;
  }).join('');
}

function selectLead(id){
  const l=myLeads.find(x=>x.id===id);
  if(!l)return;
  selectedLead=l;
  renderLeadsList();

  const st=l.status||'new';
  const svcs=(l.services_interested||[]).map(s=>`<span class="ld-pill">${esc(s)}</span>`).join('');

  document.getElementById('leadDetail').innerHTML=`
    <div class="ld-name">${esc(l.sender_name)}</div>
    <div class="ld-meta">
      ${l.sender_phone?`<a href="tel:${esc(l.sender_phone)}">üìû ${esc(l.sender_phone)}</a>`:''}
      ${l.sender_email?`<a href="mailto:${esc(l.sender_email)}">‚úâ ${esc(l.sender_email)}</a>`:''}
      <span>üìÖ ${new Date(l.created_at).toLocaleDateString('en',{month:'short',day:'numeric',year:'numeric'})}</span>
      ${l.sms_consent?'<span style="color:var(--ac);font-size:.6875rem">SMS OK</span>':''}
    </div>
    ${svcs?'<div class="ld-pills">'+svcs+'</div>':''}
    <div class="ld-msg">${esc(l.sender_message||'No message provided.')}</div>
    <div class="ld-actions">
      <select class="btn btn-o btn-sm" onchange="updateLeadStatus(${l.id},this.value)" style="font-size:.8125rem">
        <option value="new"${st==='new'?' selected':''}>New</option>
        <option value="contacted"${st==='contacted'?' selected':''}>Contacted</option>
        <option value="booked"${st==='booked'?' selected':''}>Booked</option>
        <option value="completed"${st==='completed'?' selected':''}>Completed</option>
        <option value="archived"${st==='archived'?' selected':''}>Archived</option>
      </select>
      ${l.sender_phone?`<a href="tel:${esc(l.sender_phone)}" class="btn btn-p btn-sm">Call</a>
      <a href="sms:${esc(l.sender_phone)}" class="btn btn-o btn-sm">Text</a>`:''}
    </div>
    <div class="ld-notes">
      <label style="font-size:.75rem;font-weight:600;color:var(--t3);text-transform:uppercase;display:block;margin-bottom:.25rem">Notes</label>
      <textarea id="leadNotes" placeholder="Add notes about this lead...">${esc(l.notes||'')}</textarea>
      <button class="btn btn-o btn-sm" style="margin-top:.5rem" onclick="saveLeadNotes(${l.id})">Save Notes</button>
    </div>`;
}

async function updateLeadStatus(id,status){
  await SB.from('leads').update({status,updated_at:new Date().toISOString()}).eq('id',id);
  const l=myLeads.find(x=>x.id===id);
  if(l)l.status=status;
  renderLeadsList();
  renderOverview();
}

async function saveLeadNotes(id){
  const notes=document.getElementById('leadNotes').value;
  await SB.from('leads').update({notes}).eq('id',id);
  const l=myLeads.find(x=>x.id===id);
  if(l)l.notes=notes;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TAB 3: PORTFOLIO ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function mediaPublicUrl(m){
  const bucket=m.is_placeholder?'placeholders':'media';
  return SB_URL+'/storage/v1/object/public/'+bucket+'/'+m.storage_path;
}

function renderPortfolio(){
  const grid=document.getElementById('mediaGrid');
  const hasPlaceholders=myMedia.some(m=>m.is_placeholder&&m.sort_order>=0);
  const hasReal=myMedia.some(m=>!m.is_placeholder);
  document.getElementById('placeholderBanner').style.display=hasPlaceholders&&!hasReal?'flex':'none';

  // Free tier upload limit (6 non-placeholder, non-profile uploads)
  const FREE_UPLOAD_LIMIT=6;
  const realCount=myMedia.filter(m=>!m.is_placeholder&&!m.is_profile).length;
  const atLimit=!myListing.promoted&&realCount>=FREE_UPLOAD_LIMIT;
  document.getElementById('uploadLimitMsg').style.display=atLimit?'block':'none';
  document.getElementById('uploadZone').style.display=atLimit?'none':'';
  document.getElementById('fileInput').disabled=atLimit;

  // Show real photos; only show placeholders if no real photos exist
  const items=myMedia.filter(m=>m.sort_order>=0&&(!m.is_placeholder||!hasReal));
  if(!items.length){
    grid.innerHTML='<div class="chart-none">No photos yet. Upload your first SMP photo above!</div>';
    return;
  }

  grid.innerHTML=items.map(m=>{
    const src=mediaPublicUrl(m);
    const isVideo=m.type==='video';
    if(isVideo){
      return `<div class="media-item" onclick="openVideo('${src.replace(/'/g,"\\'")}')">
        <video src="${src}" preload="metadata" muted></video>
        <div class="media-play"></div>
        <div class="media-del" onclick="event.stopPropagation();deleteMedia(${m.id})">&times;</div>
      </div>`;
    }
    return `<div class="media-item">
      <img src="${src}" loading="lazy" alt="Portfolio">
      <div class="media-del" onclick="event.stopPropagation();deleteMedia(${m.id})">&times;</div>
      ${m.is_placeholder?'<div class="media-pill">Sample</div>':''}
    </div>`;
  }).join('');
}

function openVideo(src){
  const v=document.getElementById('videoPlayer');
  v.src=src;
  document.getElementById('videoModal').classList.add('open');
  document.body.style.overflow='hidden';
  v.play().catch(()=>{});
}
function closeVideo(){
  const v=document.getElementById('videoPlayer');
  v.pause();v.src='';
  document.getElementById('videoModal').classList.remove('open');
  document.body.style.overflow='';
}

// Drag and drop
const uz=document.getElementById('uploadZone');
if(uz){
  uz.addEventListener('dragover',e=>{e.preventDefault();uz.classList.add('dragover');});
  uz.addEventListener('dragleave',()=>uz.classList.remove('dragover'));
  uz.addEventListener('drop',e=>{e.preventDefault();uz.classList.remove('dragover');handleUpload(e.dataTransfer.files);});
}

const ALLOWED_IMAGE=/\.(jpe?g|png|webp|heic)$/i;
const ALLOWED_VIDEO=/\.(mp4|mov|webm)$/i;

async function handleUpload(files){
  if(!files||!files.length||!myListing)return;
  // Free tier limit check (promoted = unlimited)
  const realCount=myMedia.filter(m=>!m.is_placeholder&&!m.is_profile).length;
  if(!myListing.promoted&&realCount>=6){renderPortfolio();return;}
  const prog=document.getElementById('uploadProgress');
  const bar=document.getElementById('uploadBarFill');
  const status=document.getElementById('uploadStatus');
  prog.style.display='block';

  const hadRealBefore=myMedia.some(m=>!m.is_placeholder);
  let uploadedCount=0;
  const maxSort=myMedia.reduce((mx,m)=>Math.max(mx,m.sort_order||0),0);

  for(let i=0;i<files.length;i++){
    const file=files[i];
    const isImage=file.type.startsWith('image/')||ALLOWED_IMAGE.test(file.name);
    const isVideo=file.type.startsWith('video/')||ALLOWED_VIDEO.test(file.name);
    if(!isImage&&!isVideo){status.textContent='Unsupported file: '+file.name;continue;}
    if(isImage&&file.size>10*1024*1024){status.textContent=file.name+' exceeds 10MB limit';continue;}
    if(isVideo&&file.size>50*1024*1024){status.textContent=file.name+' exceeds 50MB limit';continue;}

    const pct=Math.round(((i+0.5)/files.length)*100);
    bar.style.width=pct+'%';
    status.textContent='Uploading '+(i+1)+'/'+files.length+': '+file.name;

    const safeName=file.name.replace(/[^a-zA-Z0-9._-]/g,'');
    const path='listings/'+myListing.id+'/'+Date.now()+'-'+safeName;

    const{error:uploadErr}=await SB.storage.from('media').upload(path,file,{
      contentType:file.type,
      upsert:false
    });
    if(uploadErr){console.error('[UPLOAD]',uploadErr);status.textContent='Error: '+uploadErr.message;continue;}

    const newSort=maxSort+1+uploadedCount;
    const{error:insertErr}=await SB.from('media').insert({
      listing_id:myListing.id,
      type:isVideo?'video':'image',
      storage_path:path,
      is_placeholder:false,
      sort_order:newSort
    });
    if(insertErr){console.error('[UPLOAD]',insertErr);status.textContent='Error saving: '+insertErr.message;continue;}

    uploadedCount++;
    bar.style.width=Math.round(((i+1)/files.length)*100)+'%';
  }

  // If this was the first real upload, hide all placeholders
  if(!hadRealBefore&&uploadedCount>0){
    status.textContent='Hiding sample photos...';
    await SB.from('media').update({sort_order:-1}).eq('listing_id',myListing.id).eq('is_placeholder',true);
  }

  if(uploadedCount>0){
    status.textContent=uploadedCount+' file'+(uploadedCount>1?'s':'')+' uploaded!';
  }
  setTimeout(()=>{prog.style.display='none';bar.style.width='0';},2500);

  // Refresh media list
  const{data}=await SB.from('media').select('*').eq('listing_id',myListing.id).order('sort_order',{ascending:true});
  myMedia=data||[];
  renderPortfolio();
}

async function deleteMedia(id){
  if(!confirm('Delete this photo?'))return;
  const m=myMedia.find(x=>x.id===id);
  if(!m)return;
  if(!m.is_placeholder){
    const{error:delErr}=await SB.storage.from('media').remove([m.storage_path]);
    if(delErr)console.error('[DELETE storage]',delErr);
  }
  const{error:dbErr}=await SB.from('media').delete().eq('id',id);
  if(dbErr){console.error('[DELETE db]',dbErr);alert('Error deleting: '+dbErr.message);return;}
  myMedia=myMedia.filter(x=>x.id!==id);
  renderPortfolio();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TAB 4: REVIEWS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderReviews(){
  const approved=myReviews.filter(r=>r.status==='approved');
  const pending=myReviews.filter(r=>r.status==='pending');
  const all=[...myReviews];

  // Stats
  const avg=approved.length?((approved.reduce((s,r)=>s+r.rating,0)/approved.length).toFixed(1)):'0.0';
  const breakdown=[5,4,3,2,1].map(n=>{
    const count=approved.filter(r=>r.rating===n).length;
    const pct=approved.length?Math.round((count/approved.length)*100):0;
    return{n,count,pct};
  });

  document.getElementById('reviewStats').innerHTML=`
    <div class="rs-big">
      <div class="rs-num">${avg}</div>
      <div class="rs-stars">${approved.length?stars(Math.round(parseFloat(avg))):''}</div>
      <div class="rs-count">${approved.length} review${approved.length===1?'':'s'}</div>
    </div>
    <div class="rs-breakdown">
      ${breakdown.map(b=>`<div class="rs-row"><span>${b.n}</span><div class="rs-bar"><div class="rs-bar-fill" style="width:${b.pct}%"></div></div><span>${b.count}</span></div>`).join('')}
    </div>`;

  // List
  const list=document.getElementById('reviewList');
  if(!all.length){
    list.innerHTML='<div class="chart-none">No reviews yet. Request reviews from your past clients to build credibility.</div>';
  } else {
    list.innerHTML=all.map(r=>{
      const isPending=r.status==='pending';
      const hasReply=!!r.artist_reply;
      return `<div class="review-item">
        <div class="ri-head">
          <span class="ri-stars">${stars(r.rating)}</span>
          <span class="ri-name">${esc(r.reviewer_name)}${isPending?'<span class="ri-pending">Pending</span>':''}</span>
          <span class="ri-date">${ago(r.created_at)}</span>
        </div>
        ${r.title?'<div class="ri-title">'+esc(r.title)+'</div>':''}
        <div class="ri-body">${esc(r.body||'')}</div>
        ${hasReply?`<div class="ri-reply"><label>Your Reply</label><p>${esc(r.artist_reply)}</p></div>`:`
        <div class="ri-reply-form">
          <textarea id="reply-${r.id}" placeholder="Write a reply..."></textarea>
          <button class="btn btn-o btn-sm" style="margin-top:.375rem" onclick="submitReply(${r.id})">Reply</button>
        </div>`}
      </div>`;
    }).join('');
  }

}

async function submitReply(reviewId){
  const text=document.getElementById('reply-'+reviewId).value.trim();
  if(!text)return;
  await SB.from('reviews').update({artist_reply:text,artist_reply_at:new Date().toISOString()}).eq('id',reviewId);
  const r=myReviews.find(x=>x.id===reviewId);
  if(r){r.artist_reply=text;r.artist_reply_at=new Date().toISOString();}
  renderReviews();
}

function copyReviewLink(){
  const input=document.getElementById('reviewLinkInput');
  navigator.clipboard.writeText(input.value).then(()=>{
    const btn=document.getElementById('copyReviewLink');
    btn.textContent='Copied!';
    btn.style.background='#059669';
    setTimeout(()=>{btn.textContent='Copy Link';btn.style.background='';},2000);
  }).catch(()=>{
    input.select();
    document.execCommand('copy');
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TAB 5: INSIGHTS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setDateRange(days,el){
  insightsDays=days;
  document.querySelectorAll('.dr-btn').forEach(b=>b.classList.remove('on'));
  el.classList.add('on');
  renderInsights();
}

function renderInsights(){
  const now=new Date();
  const cutoff=insightsDays?new Date(now-insightsDays*86400000):new Date(0);
  const fViews=myViews.filter(v=>new Date(v.created_at)>=cutoff);
  const fLeads=myLeads.filter(l=>new Date(l.created_at)>=cutoff);

  const contacted=fLeads.filter(l=>l.status==='contacted'||l.status==='booked'||l.status==='completed').length;
  const booked=fLeads.filter(l=>l.status==='booked'||l.status==='completed').length;
  const convRate=fViews.length?((fLeads.length/fViews.length)*100).toFixed(1):0;

  document.getElementById('insightsStats').innerHTML=`
    <div class="stat"><div class="stat-label">Total Views</div><div class="stat-val">${fViews.length}</div></div>
    <div class="stat"><div class="stat-label">Total Leads</div><div class="stat-val">${fLeads.length}</div></div>
    <div class="stat"><div class="stat-label">Conversion Rate</div><div class="stat-val">${convRate}%</div></div>
    <div class="stat"><div class="stat-label">Booked</div><div class="stat-val">${booked}</div></div>`;

  // Chart
  const chartDays=insightsDays||90;
  const days=[];
  for(let i=chartDays-1;i>=0;i--){
    const d=new Date(now);d.setDate(d.getDate()-i);
    days.push({date:d,key:d.toISOString().slice(0,10),count:0});
  }
  fViews.forEach(v=>{const k=v.created_at.slice(0,10);const day=days.find(d=>d.key===k);if(day)day.count++;});

  const chart=document.getElementById('viewsChart');
  if(!fViews.length){
    chart.innerHTML='<div class="chart-none">No views in this period.</div>';
  } else {
    const max=Math.max(...days.map(d=>d.count),1);
    chart.innerHTML=days.map((d,i)=>{
      const pct=Math.round((d.count/max)*100);
      const showLabel=chartDays<=30?(d.date.getDate()%5===0||i===0):(d.date.getDate()===1);
      const label=showLabel?d.date.toLocaleDateString('en',{month:'short',day:'numeric'}):'';
      return `<div class="chart-col"><div class="chart-bar" style="height:${Math.max(pct,2)}%" title="${d.key}: ${d.count}"></div><span class="chart-label">${label}</span></div>`;
    }).join('');
  }

  // Funnel
  document.getElementById('leadFunnel').innerHTML=`
    <div class="funnel-step"><div class="funnel-num">${fViews.length}</div><div class="funnel-label">Views</div></div>
    <div class="funnel-arrow">‚Üí</div>
    <div class="funnel-step"><div class="funnel-num">${fLeads.length}</div><div class="funnel-label">Leads</div></div>
    <div class="funnel-arrow">‚Üí</div>
    <div class="funnel-step"><div class="funnel-num">${contacted}</div><div class="funnel-label">Contacted</div></div>
    <div class="funnel-arrow">‚Üí</div>
    <div class="funnel-step"><div class="funnel-num">${booked}</div><div class="funnel-label">Booked</div></div>`;

  // Weekly summary
  const weekAgo=new Date(now-7*86400000);
  const twoWeekAgo=new Date(now-14*86400000);
  const wViews=myViews.filter(v=>new Date(v.created_at)>=weekAgo).length;
  const wLeads=myLeads.filter(l=>new Date(l.created_at)>=weekAgo).length;
  const wReviews=myReviews.filter(r=>new Date(r.created_at)>=weekAgo).length;
  const pwViews=myViews.filter(v=>{const d=new Date(v.created_at);return d>=twoWeekAgo&&d<weekAgo;}).length;

  const trend=wViews>pwViews?'‚Üë':'‚Üì';
  const trendClass=wViews>=pwViews?'stat-up':'stat-down';

  document.getElementById('weeklySummary').innerHTML=`
    <h3>This Week</h3>
    <div class="ws-row">
      <div class="ws-item"><strong>${wViews}</strong> views</div>
      <div class="ws-item"><strong>${wLeads}</strong> leads</div>
      <div class="ws-item"><strong>${wReviews}</strong> new reviews</div>
      <div class="ws-item"><span class="${trendClass}">${trend} ${wViews>=pwViews?'Up':'Down'} from last week</span></div>
    </div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TAB 6: SETTINGS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function populateForm(l){
  document.getElementById('fName').value=l.name||'';
  document.getElementById('fAddress').value=l.address||'';
  document.getElementById('fCity').value=l.city||'';
  document.getElementById('fState').value=l.state||'';
  document.getElementById('fZip').value=l.zip||'';
  document.getElementById('fPhone').value=l.phone||'';
  document.getElementById('fEmail').value=l.email||'';
  document.getElementById('fWebsite').value=l.website||'';
  document.getElementById('fInstagram').value=l.instagram||'';
  document.getElementById('fFacebook').value=l.facebook||'';
  document.getElementById('fTiktok').value=l.tiktok||'';
  document.getElementById('fAbout').value=l.about||'';
  document.getElementById('fPrice').value=l.price_range||'$$';
  document.getElementById('fBookingUrl').value=l.booking_url||'';

  const svcs=l.services||[];
  document.querySelectorAll('#fServices .svc-check').forEach(el=>{
    el.classList.toggle('on',svcs.includes(el.textContent));
  });

  selectBookingType(l.booking_type||'message');
}

function selectBookingType(type){
  document.querySelectorAll('#bookingTypeSelect .bt-option').forEach(el=>{
    el.classList.toggle('on',el.dataset.type===type);
  });
  document.getElementById('bookingUrlField').style.display=type==='external'?'flex':'none';
}

async function saveSettings(){
  if(!myListing)return;
  const svcs=[...document.querySelectorAll('#fServices .svc-check.on')].map(s=>s.textContent);
  const bookingType=document.querySelector('#bookingTypeSelect .bt-option.on').dataset.type;

  const updates={
    name:document.getElementById('fName').value.trim(),
    address:document.getElementById('fAddress').value.trim(),
    city:document.getElementById('fCity').value.trim(),
    state:document.getElementById('fState').value.trim(),
    zip:document.getElementById('fZip').value.trim(),
    phone:document.getElementById('fPhone').value.trim(),
    email:document.getElementById('fEmail').value.trim(),
    website:document.getElementById('fWebsite').value.trim(),
    instagram:document.getElementById('fInstagram').value.trim().replace('@',''),
    facebook:document.getElementById('fFacebook').value.trim(),
    tiktok:document.getElementById('fTiktok').value.trim().replace('@',''),
    about:document.getElementById('fAbout').value.trim(),
    price_range:document.getElementById('fPrice').value,
    services:svcs,
    booking_type:bookingType,
    booking_url:bookingType==='external'?document.getElementById('fBookingUrl').value.trim():null
  };

  const{error}=await SB.from('listings').update(updates).eq('id',myListing.id);
  if(error){alert('Error saving: '+error.message);return;}
  Object.assign(myListing,updates);

  const msg=document.getElementById('settingsSaved');
  msg.style.display='inline';
  setTimeout(()=>msg.style.display='none',3000);
  renderOverview();
  renderBooking();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PROFILE PHOTO ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderProfilePhoto(){
  const preview=document.getElementById('profilePhotoPreview');
  const initials=document.getElementById('profileInitials');
  const removeBtn=document.getElementById('removeProfilePhoto');
  const profileMedia=myMedia.find(m=>m.is_profile);

  if(profileMedia){
    const src=mediaPublicUrl(profileMedia);
    preview.innerHTML=`<img src="${src}" style="width:100%;height:100%;object-fit:cover" alt="Profile">`;
    removeBtn.style.display='';
  } else {
    const ini=(myListing.name||'').split(' ').map(w=>w[0]).slice(0,2).join('');
    preview.innerHTML=`<span id="profileInitials">${ini}</span>`;
    removeBtn.style.display='none';
  }

  // Update sidebar avatar too
  const sbAv=document.getElementById('sbAvatar');
  if(profileMedia){
    const src=mediaPublicUrl(profileMedia);
    sbAv.innerHTML=`<img src="${src}" style="width:100%;height:100%;object-fit:cover;border-radius:50%" alt="">`;
  } else {
    const ini=(myListing.email||'').split('@')[0].slice(0,2).toUpperCase();
    sbAv.textContent=ini;
  }
}

async function uploadProfilePhoto(files){
  if(!files||!files.length||!myListing)return;
  const file=files[0];
  const msg=document.getElementById('profilePhotoMsg');
  msg.textContent='';

  if(!file.type.match(/^image\/(jpeg|png|webp)$/)){
    msg.innerHTML='<span style="color:#DC2626">Please upload a JPEG, PNG, or WebP image.</span>';
    return;
  }
  if(file.size>5*1024*1024){
    msg.innerHTML='<span style="color:#DC2626">Image must be under 5MB.</span>';
    return;
  }

  msg.innerHTML='<span style="color:var(--ac)">Uploading...</span>';

  // Remove old profile photo first
  const oldProfile=myMedia.find(m=>m.is_profile);
  if(oldProfile){
    if(!oldProfile.is_placeholder){
      await SB.storage.from('media').remove([oldProfile.storage_path]);
    }
    await SB.from('media').delete().eq('id',oldProfile.id);
    myMedia=myMedia.filter(m=>m.id!==oldProfile.id);
  }

  // Upload new
  const safeName=file.name.replace(/[^a-zA-Z0-9._-]/g,'');
  const path='listings/'+myListing.id+'/profile-'+Date.now()+'-'+safeName;

  const{error:upErr}=await SB.storage.from('media').upload(path,file,{contentType:file.type,upsert:false});
  if(upErr){msg.innerHTML='<span style="color:#DC2626">Upload error: '+upErr.message+'</span>';return;}

  const{data:insertData,error:insertErr}=await SB.from('media').insert({
    listing_id:myListing.id,
    type:'image',
    storage_path:path,
    is_placeholder:false,
    is_profile:true,
    sort_order:-1
  }).select();
  if(insertErr){msg.innerHTML='<span style="color:#DC2626">Error: '+insertErr.message+'</span>';return;}

  if(insertData&&insertData.length)myMedia.push(insertData[0]);
  msg.innerHTML='<span style="color:var(--ac)">Profile photo updated!</span>';
  setTimeout(()=>{msg.textContent='';},3000);
  renderProfilePhoto();
}

async function removeProfilePhoto(){
  if(!myListing)return;
  const profileMedia=myMedia.find(m=>m.is_profile);
  if(!profileMedia)return;

  if(!profileMedia.is_placeholder){
    await SB.storage.from('media').remove([profileMedia.storage_path]);
  }
  await SB.from('media').delete().eq('id',profileMedia.id);
  myMedia=myMedia.filter(m=>m.id!==profileMedia.id);
  renderProfilePhoto();
}

function archiveListing(){
  document.getElementById('confirmOverlay').style.display='flex';
}

async function confirmArchive(){
  await SB.from('listings').update({status:'archived'}).eq('id',myListing.id);
  document.getElementById('confirmOverlay').style.display='none';
  alert('Your listing has been archived.');
  window.location.href='/';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TAB 7: BOOKING ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderBooking(){
  const type=myListing.booking_type||'message';
  const url=myListing.booking_url||'';

  // Populate inline form
  document.querySelectorAll('#bookingTypeInline .bt-option').forEach(el=>{
    el.classList.toggle('on',el.dataset.type===type);
  });
  document.getElementById('bookingUrlInline').style.display=type==='external'?'block':'none';
  document.getElementById('fBookingUrlInline').value=url;

  // Booking clicks this month
  const now=new Date();
  const ms=new Date(now.getFullYear(),now.getMonth(),1);
  const clicks=myViews.filter(v=>v.created_at&&new Date(v.created_at)>=ms).length;
  document.getElementById('bookingClicks').textContent=clicks;

  // Preview
  const preview=document.getElementById('bookingPreview');
  if(type==='external'&&url){
    preview.innerHTML=`
      <div style="background:var(--bg);padding:.75rem 1rem;border-radius:var(--rs);border:1px solid var(--bd)">
        <div style="font-size:.75rem;font-weight:600;color:var(--t3);text-transform:uppercase;margin-bottom:.25rem">Current Booking Link</div>
        <div style="font-size:.8125rem;word-break:break-all;margin-bottom:.5rem">${esc(url)}</div>
        <a href="${esc(url)}" target="_blank" class="btn btn-o btn-sm">Test Link</a>
      </div>`;
  } else {
    preview.innerHTML=`
      <div style="background:var(--bg);padding:.75rem 1rem;border-radius:var(--rs);border:1px solid var(--bd)">
        <div style="font-size:.75rem;font-weight:600;color:var(--t3);text-transform:uppercase;margin-bottom:.25rem">Current Method</div>
        <div style="font-size:.8125rem;color:var(--t2)">Message only ‚Äî clients contact you through the form on your listing.</div>
      </div>`;
  }
}

function selectBookingTypeInline(type){
  document.querySelectorAll('#bookingTypeInline .bt-option').forEach(el=>{
    el.classList.toggle('on',el.dataset.type===type);
  });
  document.getElementById('bookingUrlInline').style.display=type==='external'?'block':'none';
}

async function saveBooking(){
  if(!myListing)return;
  const type=document.querySelector('#bookingTypeInline .bt-option.on').dataset.type;
  const url=type==='external'?document.getElementById('fBookingUrlInline').value.trim():null;

  const{error}=await SB.from('listings').update({booking_type:type,booking_url:url}).eq('id',myListing.id);
  if(error){alert('Error saving: '+error.message);return;}
  myListing.booking_type=type;
  myListing.booking_url=url;

  // Also sync the Settings tab form
  selectBookingType(type);
  document.getElementById('fBookingUrl').value=url||'';

  const msg=document.getElementById('bookingSaved');
  msg.style.display='inline';
  setTimeout(()=>msg.style.display='none',3000);
  renderBooking();
  renderOverview();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TAB SWITCHING ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showTab(name){
  document.querySelectorAll('.sb-link').forEach(el=>{
    el.classList.toggle('on',el.dataset.tab===name);
  });
  document.querySelectorAll('.dtab').forEach(t=>t.classList.toggle('active',t.id==='dtab-'+name));
}

// Close modals on Escape
document.addEventListener('keydown',e=>{
  if(e.key==='Escape'){
    document.getElementById('confirmOverlay').style.display='none';
  }
});
</script>
</body>
</html>
